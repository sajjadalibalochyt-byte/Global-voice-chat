<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat - Connect & Earn</title>
    <!-- ONESIGNAL PUSH NOTIFICATION SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "e5e6c86b-802a-42ba-af17-b5d4cf0584ad",
          safari_web_id: "web.onesignal.auto.0f5650bb-bc45-4dc5-a4b8-8665864d5e48",
          notifyButton: {
            enable: true,
          },
        });
      });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .coins-display {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative; /* For notification dot positioning */
        }
        
        .tab[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab.active, .tab:not([disabled]):hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .content {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .hidden {
            display: none;
        }

        /* Chat Styles */
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.1);
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 15px;
            max-width: 85%;
            animation: messageSlide 0.3s ease;
        }

        .message-wrapper.own {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-wrapper.other {
            margin-right: auto;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            margin: 0 10px;
            flex-shrink: 0;
            overflow: visible; /* Allow frame to show outside */
            align-self: flex-start;
            position: relative; /* Crucial for frame positioning */
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%; /* Chat avatars ko gol rakhein */
        }
        
        .message-avatar span {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .message {
            padding: 10px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            align-items: flex-end;
        }

        .message.other {
            background: rgba(255,255,255,0.2);
            align-items: flex-start;
        }
        
        .message-wrapper.system {
            max-width: 100%;
        }

        .message.system {
            background: rgba(255, 215, 0, 0.2);
            width: 100%;
            max-width: 100%;
            text-align: center;
            font-style: italic;
            color: #ffd700;
        }

        .message-header {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .message-text {
            font-size: 1rem;
            line-height: 1.4;
        }
        
        /* Styles for media in messages */
        .message-text img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            margin-top: 5px;
            cursor: pointer;
        }
        .message-text audio {
            width: 100%;
            max-width: 250px;
            margin-top: 5px;
        }


        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .chat-input input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .send-btn, .gift-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px; /* Adjusted padding for icons */
            min-width: 55px;
            text-align: center;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* Different color for non-gift buttons */
        .chat-input .send-btn { background: linear-gradient(135deg, #00b894, #00a085); }
        .chat-input .gift-btn { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }


        .send-btn:hover, .gift-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .send-btn[disabled], .gift-btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        /* Style for readonly inputs to look different */
        .form-group input[readonly] {
            background-color: rgba(255, 255, 255, 0.05);
            cursor: not-allowed;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .form-group select option {
            background-color: #667eea;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        /* NEW Style for progress bars in profile */
        .progress-bar-container {
            background: rgba(0,0,0,0.3); 
            border-radius: 5px; 
            height: 10px; 
            overflow: hidden;
            width: 100%;
        }
        .progress-bar-fill {
            height: 100%; 
            background: linear-gradient(90deg, #ffd700, #ffae00); 
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        .progress-bar-text {
            text-align: center; 
            font-size: 0.8em; 
            opacity: 0.7; 
            margin-top: 5px;
        }


        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-google {
            background: #fff;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-google:hover {
            background: #f1f1f1;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        /* User List */
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .user-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative; /* For notification dot */
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%; /* Container ko GOL rakhein */
            margin: 0 auto 15px;
            position: relative; /* Sab se zaroori */
            background: rgba(0,0,0,0.2); /* Fallback background */
            display: flex; /* For text fallback */
            align-items: center; /* For text fallback */
            justify-content: center; /* For text fallback */
            font-size: 2rem; /* For text fallback */
            color: white; /* For text fallback */
            overflow: visible; /* Allow frame to overflow */
        }
        
        .user-avatar img {
            width: 90%;
            height: 90%;
            object-fit: cover;
            border-radius: 50%; /* Picture ko bhi GOL karein */
        }
        
        /* New User Status Text Style */
        .user-status-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-status-text .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .user-status-text.online {
            color: #00b894;
        }

        .user-status-text.online .dot {
            background-color: #00b894;
        }

        .user-status-text.offline {
            color: #a4b0be;
        }

        .user-status-text.offline .dot {
            background-color: #747d8c;
        }

        .user-info h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            margin: 0;
        }

        .btn-message {
            background: linear-gradient(135deg, #3742fa, #2f3542);
            color: white;
        }

        .btn-gift {
            background: linear-gradient(135deg, #ff9ff3, #f368e0);
            color: white;
        }
        
        /* Level Badge CSS */
        .wealth-level-badge, .charm-level-badge {
            color: #333;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
            margin-right: 5px;
            vertical-align: middle;
            display: inline-block;
        }
        
        .wealth-level-badge {
            background: linear-gradient(135deg, #ffd700, #feca57);
        }
        
        .charm-level-badge {
            background: linear-gradient(135deg, #ff9ff3, #f368e0);
            color: white;
        }

        .vip-badge {
            background: linear-gradient(135deg, #c471ed, #f64f59);
            color: white;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
            text-transform: uppercase;
        }
        
        /* --- UNIVERSAL AVATAR FRAME STYLE --- */
        .avatar-frame {
            position: absolute;
            width: 140%; /* Adjust size as needed */
            height: 140%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Let clicks pass through */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 5;
        }
        /* Specific frame for legacy VIP badge */
        .profile-frame {
            position: absolute;
            width: 140%;
            height: 130%;
            top: -18%;
            left: -18%;
            pointer-events: none; /* Let clicks pass through */
            background-image: url('https://iili.io/FZJCfC7.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        /* Frame in chat message list */
        .message-avatar .avatar-frame {
            width: 150%;
            height: 150%;
        }


        /* Gift Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .modal-body {
            overflow-y: auto;
        }

        .close {
            color: white;
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gift-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative; /* For lucky badge */
        }

        .gift-item:hover, .gift-item.selected {
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .gift-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .gift-price {
            font-weight: 600;
            color: #ffd700;
        }
        
        /* Referral Explanation Styles */
        .referral-explanation {
            background: rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }
        .referral-explanation h4 {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 20px;
        }
        .referral-explanation ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 20px;
        }
        .referral-explanation ul li {
            margin-bottom: 12px;
            padding-left: 25px;
            position: relative;
        }
        .referral-explanation ul li::before {
            content: '✓';
            color: #00b894;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        .referral-explanation .reward-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .referral-explanation .reward-table th, 
        .referral-explanation .reward-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .referral-explanation .reward-table th {
            font-weight: 600;
            opacity: 0.9;
        }

        /* NEW: Styles for My Referrals List */
        .referral-list-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .referral-list-item .user-avatar {
            width: 50px;
            height: 50px;
            margin: 0;
            flex-shrink: 0;
        }
        .referral-info {
            flex-grow: 1;
        }
        .referral-info .name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .referral-status {
            text-align: right;
            font-weight: bold;
            flex-shrink: 0;
        }
        .referral-status.unlocked {
            color: #00b894;
        }
        .referral-status.pending {
            color: #ffd700;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                gap: 5px;
            }

            .tab {
                padding: 10px 18px;
            }
            
            .user-list {
                grid-template-columns: 1fr;
            }
            
            .chat-input {
                flex-wrap: wrap; /* Allow buttons to wrap on small screens */
            }
            .chat-input input[type="text"] {
                flex-basis: 100%; /* Make input take full width */
                margin-bottom: 10px; /* Add space when wrapped */
            }
            .chat-input .send-btn, .chat-input .gift-btn {
                flex-grow: 1; /* Allow buttons to share space */
            }
            
            .modal-content {
                width: 95%;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 2000;
            transform: translateX(calc(100% + 30px));
            transition: transform 0.5s ease-in-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 350px;
        }
        
        .notification.success { background: rgba(0, 184, 148, 0.9); }
        .notification.error { background: rgba(231, 76, 60, 0.9); }
        .notification.info { background: rgba(52, 152, 219, 0.9); }

        .notification.show {
            transform: translateX(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .admin-list-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .profile-edit-actions {
            display: flex;
            gap: 10px;
        }

        /* --- STYLES FOR MOMENTS/POSTS/VIDEOS --- */
        .post-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .post-header .user-avatar {
            width: 50px;
            height: 50px;
            margin: 0;
        }

        .post-header-info h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .post-header-info p {
            margin: 0;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .post-body .post-text {
            margin-bottom: 15px;
            line-height: 1.5;
            white-space: pre-wrap; /* To respect new lines in text */
            word-wrap: break-word;
        }

        .post-body .post-image, .post-body .post-video {
            max-width: 100%;
            border-radius: 10px;
            cursor: pointer;
            background-color: #000;
        }
        
        .post-body .post-video {
            display: block;
            margin: 0 auto;
        }

        .post-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-btn.active {
            background: #ff6b6b;
            color: white;
        }

        .post-stats {
            font-size: 0.9rem;
            opacity: 0.8;
            padding-bottom: 10px;
        }

        .post-comments {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
            margin-top: 15px;
        }

        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            align-items: flex-start;
        }
        .comment p {
            background: rgba(0,0,0,0.1);
            padding: 8px 12px;
            border-radius: 10px;
            flex: 1;
            margin: 0;
            line-height: 1.4;
        }
        .comment strong {
            color: #ffd700;
        }

        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .comment-input-area input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* --- NEW LEADERBOARD STYLES --- */
        .leaderboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .leaderboard-section h3 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            counter-reset: leaderboard-rank;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .leaderboard-item {
            background: rgba(0,0,0,0.15);
            border-radius: 12px;
            margin-bottom: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
        }

        .leaderboard-item::before {
            content: counter(leaderboard-rank);
            counter-increment: leaderboard-rank;
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(255,255,255,0.5);
            width: 30px;
            text-align: center;
        }

        .leaderboard-item:nth-child(1) { border-left-color: #ffd700; }
        .leaderboard-item:nth-child(2) { border-left-color: #c0c0c0; }
        .leaderboard-item:nth-child(3) { border-left-color: #cd7f32; }

        .leaderboard-item:nth-child(1)::before { color: #ffd700; }
        .leaderboard-item:nth-child(2)::before { color: #c0c0c0; }
        .leaderboard-item:nth-child(3)::before { color: #cd7f32; }

        .leaderboard-item .user-avatar {
            width: 45px;
            height: 45px;
            margin: 0;
            flex-shrink: 0;
        }
        
        .leaderboard-item .user-avatar span {
            font-size: 1.5rem;
        }

        .leaderboard-item-info {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-item-info .name {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .leaderboard-item-info .score {
            font-size: 0.9em;
            opacity: 0.8;
            color: #ffd700;
        }

        /* --- NEW SHOP & FRAME STYLES --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .frame-item {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .frame-preview {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
        }
        .frame-name {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .frame-price {
            color: #ffd700;
            margin-bottom: 15px;
        }
        .my-frames-grid {
             display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
        }
        .my-frame-item {
            text-align: center;
        }
        .my-frame-item img {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }

        /* --- VOICE ROOM STYLES --- */
        .voice-room-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .voice-room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .voice-room-info h4 {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
        }
        .voice-room-info p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .voice-room-view {
            display: none; /* Shown by JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1500;
            flex-direction: column;
            padding: 20px;
        }
        .voice-room-view.show { display: flex; }
        
        .voice-room-header {
            text-align: center;
            padding: 10px;
            flex-shrink: 0;
        }
        
        .voice-room-main {
            flex-grow: 1;
            display: flex;
            gap: 20px;
            overflow: hidden;
        }
        
        .voice-room-seats-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-room-seats-grid {
            display: grid;
            gap: 20px;
            padding: 20px;
            max-width: 800px;
            width: 100%;
        }
        .voice-room-seats-grid.seats-4 { grid-template-columns: repeat(2, 1fr); }
        .voice-room-seats-grid.seats-6 { grid-template-columns: repeat(3, 1fr); }
        .voice-room-seats-grid.seats-9 { grid-template-columns: repeat(3, 1fr); }

        .voice-room-seat {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .voice-room-seat.speaking {
            border-color: #00b894;
            box-shadow: 0 0 15px #00b894;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .voice-room-seat .user-avatar { margin-bottom: 10px; }
        .voice-room-seat .seat-name { font-weight: 600; word-break: break-all; }
        .voice-room-seat .seat-status { font-size: 0.8em; opacity: 0.7; }
        .voice-room-seat.empty { background: rgba(0,0,0,0.1); border-style: dashed; }
        .voice-room-seat.empty .seat-name { opacity: 0.5; }

        .voice-room-chat-panel {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.15);
            border-radius: 15px;
            padding: 15px;
            overflow: hidden;
        }
        .voice-room-chat-panel .messages { height: 100%; }

        .voice-room-controls {
            flex-shrink: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }


        @media (max-width: 992px) {
            .voice-room-main {
                flex-direction: column;
            }
            .voice-room-chat-panel {
                width: 100%;
                height: 250px;
                flex-shrink: 1;
            }
        }
        
        @media (max-width: 768px) {
            .leaderboard-container {
                grid-template-columns: 1fr;
            }
            .shop-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    <div id="audio-elements-container"></div>
    <div class="container">
        <!-- Main Header: Hidden by default -->
        <div id="main-header" class="hidden">
            <div class="header">
                <h1>🌍 Global Chat</h1>
                <div class="coins-display">
                    <span id="userDisplay">👤 Guest</span> | 
                    <span id="coinsDisplay">💰 Coins: 0</span> | 
                    <span id="pointsDisplay">💎 Points: 0</span> | 
                    <span id="onlineUsersDisplay">🟢 Online: 0</span>
                </div>
            </div>

            <div class="tabs">
                <button id="globalChatTabBtn" class="tab" onclick="showTab('globalChat')">💬 Global Chat</button>
                <button id="inboxTabBtn" class="tab" onclick="showTab('users')">📨 Inbox</button>
                <!-- NEW VOICE ROOMS TAB BUTTON -->
                <button id="voiceRoomsTabBtn" class="tab" onclick="showTab('voiceRooms')">🎙️ Voice Rooms</button>
                <button id="momentsTabBtn" class="tab" onclick="showTab('moments')">🌟 Moments</button>
                <button id="videosTabBtn" class="tab" onclick="showTab('videos')">🎥 Videos</button>
                <button id="profileTabBtn" class="tab" onclick="showTab('profile')">👤 Profile</button>
                <button id="earnTabBtn" class="tab" onclick="showTab('earn')">💰 Earn & Buy</button>
                <button id="shopTabBtn" class="tab" onclick="showTab('shop')">🛍️ Shop</button>
                <button id="walletTabBtn" class="tab" onclick="showTab('wallet')">💳 Wallet</button>
                <button id="leaderboardTabBtn" class="tab" onclick="showTab('leaderboard')">🏆 Leaderboard</button>
            </div>
        </div>

        <div class="content fade-in">
            <!-- Login Tab -->
            <div id="login" class="tab-content">
                <div style="max-width: 400px; margin: 0 auto; text-align: center;">
                    <h2 style="margin-bottom: 20px;">Global Chat website</h2>
                    
                    <!-- Email/Password Form -->
                    <div class="form-group">
                        <input type="email" id="loginEmail" placeholder="Email" style="text-align: center;">
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="Password" style="text-align: center;">
                    </div>
                    <button class="btn" style="margin-top:0;" onclick="signInWithEmail()">Sign In</button>
                    
                    <p style="margin: 20px 0; opacity: 0.8;">OR</p>
                    
                    <!-- Google Button -->
                    <button class="btn btn-google" onclick="loginWithGoogle()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"></path><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"></path><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"></path><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"></path><path d="M1 1h22v22H1z" fill="none"></path></svg>
                        Sign In with Google
                    </button>
                    
                    <p style="margin-top: 25px; opacity: 0.8;">
                        Don't have an account? <a href="#" onclick="showEmailSignupView(true)" style="color: #ffd700; text-decoration: none; font-weight: bold;">Sign Up</a>
                    </p>
                </div>
            </div>

            <!-- Email/Password Signup Tab -->
            <div id="emailSignup" class="tab-content hidden">
                <div style="max-width: 400px; margin: 0 auto; text-align: center;">
                    <h2 style="margin-bottom: 30px;">Create an Account</h2>
                    
                    <div class="form-group">
                        <input type="email" id="signupEmail" placeholder="Email" style="text-align: center;">
                    </div>
                    <div class="form-group">
                        <input type="password" id="signupPassword" placeholder="Password (min. 6 characters)" style="text-align: center;">
                    </div>
                    <div class="form-group">
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" style="text-align: center;">
                    </div>
                    
                    <button class="btn" style="margin-top:0;" onclick="signUpWithEmail()">Sign Up</button>
                    
                    <p style="margin-top: 25px; opacity: 0.8;">
                        Already have an account? <a href="#" onclick="showEmailSignupView(false)" style="color: #ffd700; text-decoration: none; font-weight: bold;">Sign In</a>
                    </p>
                </div>
            </div>

            <!-- Registration Form Tab -->
            <div id="registration" class="tab-content hidden">
                <div style="max-width: 450px; margin: 0 auto; text-align: left;">
                    <h2 style="text-align: center; margin-bottom: 30px;">Create Your Profile</h2>
                    <p style="text-align: center; margin-bottom: 20px; opacity: 0.8;">Join our community by filling out the details below.</p>
                    
                    <div class="form-group">
                        <label for="regFullName">Full Name</label>
                        <input type="text" id="regFullName" placeholder="Enter your full name">
                    </div>

                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" placeholder="Your email" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="regUsername">Username</label>
                        <input type="text" id="regUsername" placeholder="e.g., imsajjadali (no spaces, unique)">
                        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">This will be your permanent ID and Referral Code.</p>
                    </div>

                    <div class="form-group">
                        <label for="regAge">Age</label>
                        <input type="number" id="regAge" placeholder="Enter your age">
                    </div>
                    
                    <div class="form-group">
                        <label for="regMobileNumber">Mobile Number (for payments)</label>
                        <input type="tel" id="regMobileNumber" placeholder="e.g., 03123456789">
                    </div>

                    <div class="form-group">
                        <label for="regGender">Gender</label>
                        <select id="regGender">
                            <option value="" disabled selected>-- Select your gender --</option>
                            <option value="boy">Boy</option>
                            <option value="girl">Girl</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="regCountry">Country</label>
                        <select id="regCountry">
                            <option value="" disabled selected>-- Select your country --</option>
                            <option value="PK">Pakistan</option>
                            <option value="IN">India</option>
                            <option value="BD">Bangladesh</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="regReferralCode">Referral Code (Optional)</label>
                        <input type="text" id="regReferralCode" placeholder="Enter friend's username">
                        <!-- UPDATED REFERRAL TEXT -->
                        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">Your referrer gets a bonus once you earn 10,000 points from your activities!</p>
                    </div>

                    <button id="completeRegBtn" class="btn btn-success" onclick="registerNewUser()">🚀 Complete Registration</button>
                </div>
            </div>

            <!-- Global Chat Tab -->
            <div id="globalChat" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 20px;">🌍 Global Chat Room</h2>
                <div class="chat-container">
                    <div class="messages" id="globalMessages"></div>
                    <div class="chat-input">
                        <!-- Hidden file input for global chat image upload -->
                        <input type="file" id="globalImageInput" class="hidden" accept="image/*" onchange="handleImageUpload(event, 'global')">
                        
                        <input type="text" id="globalMessageInput" placeholder="Type your message..." onkeypress="handleGlobalEnter(event)">
                        
                        <button class="send-btn" onclick="sendGlobalTextMessage()" title="Send Message">📨</button>
                        <button class="gift-btn" onclick="document.getElementById('globalImageInput').click()" title="Send Image">📷</button>
                        <button id="globalVoiceRecordBtn" class="gift-btn" onclick="toggleVoiceRecording('global')" title="Send Voice Message">🎤</button>
                    </div>
                </div>
            </div>

            <!-- Private Chat View -->
            <div id="privateChat" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 20px;" id="privateChatHeader">📱 Private Chat</h2>
                 <button class="btn-small" onclick="showTab('users')" style="margin-bottom: 20px;">&larr; Back to Inbox</button>
                <div id="privateChatContainer">
                    <div class="chat-container">
                        <div class="messages" id="privateMessages"></div>
                        <div class="chat-input">
                            <!-- Renamed id for clarity -->
                            <input type="file" id="privateImageInput" class="hidden" accept="image/*" onchange="handleImageUpload(event, 'private')">
                            
                            <input type="text" id="privateMessageInput" placeholder="Type your message..." onkeypress="handlePrivateEnter(event)">
                            <button class="send-btn" onclick="sendPrivateMessage()" id="sendPrivateBtn" title="Send Message">📤</button>
                            <!-- Updated onclick to trigger specific input -->
                            <button class="gift-btn" onclick="document.getElementById('privateImageInput').click()" title="Send Image">📷</button>
                            <!-- Renamed id and updated onclick context -->
                            <button id="privateVoiceRecordBtn" class="gift-btn" onclick="toggleVoiceRecording('private')" title="Send Voice Message">🎤</button>
                            <button class="gift-btn" style="background: linear-gradient(135deg, #ff9ff3, #f368e0);" onclick="openGiftModal()" title="Send Gift">🎁</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab (Content for Inbox) -->
            <div id="users" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 20px;">📨 Inbox & Users</h2>
                <div class="form-group">
                    <input type="text" id="userSearchInput" onkeyup="filterUsers()" placeholder="Search by username or ID...">
                </div>
                <div class="user-list" id="usersList"></div>
            </div>

            <!-- NEW VOICE ROOMS TAB -->
            <div id="voiceRooms" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0;">🎙️ Live Voice Rooms</h2>
                    <button class="btn btn-success" style="width: auto; margin:0;" onclick="openCreateVoiceRoomModal()">+ Create Room</button>
                </div>
                <div id="voiceRoomsList" class="user-list" style="grid-template-columns: 1fr;">
                    <!-- Active voice rooms will be loaded here -->
                    <p>Loading active rooms...</p>
                </div>
            </div>

            <!-- Moments/Posts Tab -->
            <div id="moments" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="text-align: center;">🌟 Community Moments</h2>
                    <button class="btn btn-success" style="width: auto;" onclick="openCreatePostModal()">+ Create Post</button>
                </div>
                <div id="posts-feed" class="user-list" style="grid-template-columns: 1fr; max-height: 600px;">
                    <!-- Posts will be loaded here by JavaScript -->
                    <p>Loading moments...</p>
                </div>
            </div>

            <!-- NEW Videos Tab -->
            <div id="videos" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="text-align: center;">🎥 Community Videos</h2>
                    <button class="btn btn-success" style="width: auto;" onclick="openCreateVideoModal()">+ Upload Video</button>
                </div>
                <div id="videos-feed" class="user-list" style="grid-template-columns: 1fr; max-height: 600px;">
                    <!-- Videos will be loaded here by JavaScript -->
                    <p>Loading videos...</p>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile" class="tab-content hidden">
                <div style="max-width: 500px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">👤 My Profile</h2>
                    <div id="profileInfo" class="user-card" style="margin-bottom: 30px; cursor: default;"></div>
                    
                    <!-- Hidden file input for profile picture -->
                    <input type="file" id="profilePicInput" class="hidden" accept="image/*" onchange="handleProfilePicUpload(event)">
                    
                    <!-- NEW My Frames Section -->
                    <div id="myFramesSection" class="form-group">
                        <label>My Frames (Click to Equip)</label>
                        <div id="myFramesGrid" class="my-frames-grid">
                            <!-- Owned frames will be populated here by JS -->
                            <p style="opacity:0.7; grid-column: 1 / -1;">You don't own any frames yet. Visit the shop!</p>
                        </div>
                    </div>


                    <div class="form-group">
                        <label>Display Name (Editable)</label>
                        <input type="text" id="profileDisplayName" readonly>
                        <p class="edit-note hidden" style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">First change is free. Subsequent changes cost 10,000 coins.</p>
                    </div>
                    
                    <!-- DIV FOR WEALTH LEVEL -->
                    <div class="form-group">
                        <label>Wealth Level (From Gifts Sent)</label>
                        <div id="profileWealthLevel" style="background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 10px;">
                            <!-- Level will be inserted here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- DIV FOR CHARM LEVEL -->
                    <div class="form-group">
                        <label>Charm Level (From Gifts Received)</label>
                        <div id="profileCharmLevel" style="background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 10px;">
                            <!-- Level will be inserted here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- NEW DIV FOR REFERRAL PROGRESS -->
                    <div class="form-group">
                        <label>Referral Unlock Progress</label>
                        <div id="profileReferralProgress" style="background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 10px;">
                            <!-- Progress will be inserted here by JavaScript -->
                        </div>
                    </div>

                     <div class="form-group">
                        <label>Your Points (Earnings)</label>
                        <input type="text" id="profilePoints" readonly>
                    </div>
                    <div class="form-group">
                        <label>Username (Permanent)</label>
                        <input type="text" id="profileUsername" readonly>
                    </div>
                    <div class="form-group">
                        <label>Registered Mobile Number</label>
                        <input type="tel" id="profileMobileNumber" readonly>
                        <p class="edit-note hidden" style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">First change is free. Subsequent changes cost 10,000 coins.</p>
                    </div>
                    <div class="form-group">
                        <label>Your Referral Code (Share this!)</label>
                        <input type="text" id="myReferralCode" readonly>
                    </div>

                    <button id="editProfileBtn" class="btn" onclick="toggleProfileEditMode(true)">✏️ Edit Profile</button>
                    
                    <div id="profileEditActions" class="profile-edit-actions hidden">
                        <button id="saveProfileBtn" class="btn btn-success" onclick="saveProfileChanges()">💾 Save Changes</button>
                        <button id="cancelProfileBtn" class="btn btn-danger" onclick="toggleProfileEditMode(false)">❌ Cancel</button>
                    </div>
                    
                    <button class="btn btn-danger" onclick="logout()" style="margin-top: 20px;">🚪 Logout</button>
                </div>
            </div>

            <!-- Earn Coins Tab -->
            <div id="earn" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 30px;">💰 Earn & Buy Coins Reffral</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="dailyRewardCoins">...</div>
                        <div class="stat-label">Daily Login Reward</div>
                        <button class="btn btn-success" onclick="claimDailyReward()" id="dailyRewardBtn" disabled>🎁 Claim Now</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">30</div>
                        <div class="stat-label">Coins per Ad</div>
                        <button class="btn" onclick="watchAd()">📺 Watch Ad</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">Earn 10,000💎 </div>
                        <div class="stat-label">Referral Bonus</div>
                        <button class="btn" onclick="shareReferral()">📤 Share My Code</button>
                    </div>
                </div>
                
                <!-- NEW REFERRAL SYSTEM EXPLANATION -->
                <div class="referral-explanation">
                    <h4>🤝 Referral System Explained</h4>
                    <ul>
                        <li>For your referral to count, the new user you invite must earn <strong>10,000 points</strong> through their own activities (like receiving gifts or paid messages).</li>
                        <li>Once they reach this goal, rewards are instantly sent to you and up to 4 other people in your referral chain!</li>
                        <li>This system ensures that only active users generate rewards, making the community stronger.</li>
                    </ul>
                    <p style="text-align: center; font-weight: bold; margin-bottom: 15px;">Reward Distribution (Per Unlocked User):</p>
                    <table class="reward-table">
                        <thead>
                            <tr><th>Level</th><th>Who Gets Reward</th><th>Points</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Level 1</td><td>Your direct invitee's referrer (You)</td><td>3,000</td></tr>
                            <tr><td>Level 2</td><td>Your referrer</td><td>2,500</td></tr>
                            <tr><td>Level 3</td><td>Your referrer's referrer</td><td>2,000</td></tr>
                            <tr><td>Level 4</td><td>Level 3's referrer</td><td>1,500</td></tr>
                            <tr><td>Level 5</td><td>Level 4's referrer</td><td>1,000</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- NEW: MY REFERRALS LIST -->
                <div id="myReferralsContainer" style="margin-top: 30px;">
                    <h3 style="text-align: center; margin-bottom: 20px;">My Referrals</h3>
                    <div id="myReferralsList" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                        <p style="text-align:center; opacity: 0.7;">Loading your referrals...</p>
                    </div>
                </div>

                <h3 style="text-align: center; margin-top: 40px; margin-bottom: 20px; opacity: 0.9;">🛒 Buy Coin Packages</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">500</div>
                        <div class="stat-label">Coins</div>
                        <div style="margin: 15px 0; font-size: 1.2rem; color: #ffd700;">Rs. 10</div>
                        <button class="btn btn-success" onclick="buyCoins(500, 10)">💳 Buy Now</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">1500</div>
                        <div class="stat-label">Coins</div>
                        <div style="margin: 15px 0; font-size: 1.2rem; color: #ffd700;">Rs. 20</div>
                        <button class="btn btn-success" onclick="buyCoins(1500, 20)">💳 Buy Now</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">2500</div>
                        <div class="stat-label">Coins</div>
                        <div style="margin: 15px 0; font-size: 1.2rem; color: #ffd700;">Rs. 30</div>
                        <button class="btn btn-success" onclick="buyCoins(2500, 30)">💳 Buy Now</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">5000</div>
                        <div class="stat-label">Coins</div>
                        <div style="margin: 15px 0; font-size: 1.2rem; color: #ffd700;">Rs. 50</div>
                        <button class="btn btn-success" onclick="buyCoins(5000, 50)">💳 Buy Now</button>
                    </div>
                </div>
                 <p style="text-align: center; opacity: 0.8; margin-top: 20px;">Payment will be verified manually by an admin.</p>
            </div>
            
            <!-- NEW Shop Tab -->
            <div id="shop" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 30px;">🛍️ Frame Shop</h2>

                <h3 style="margin-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 10px;">✨ Animated Frames</h3>
                <div id="animated-frames-grid" class="shop-grid">
                    <!-- Animated frames will be populated here -->
                </div>
                
                <h3 style="margin-top: 40px; margin-bottom: 10px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 10px;">🖼️ Static Frames</h3>
                <div id="static-frames-grid" class="shop-grid">
                    <!-- Static frames will be populated here -->
                </div>
            </div>

            <!-- Wallet Tab -->
            <div id="wallet" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 30px;">💳 Wallet & Withdrawals</h2>
                
                <div class="form-group">
                    <label>Withdrawal Method</label>
                    <select id="withdrawalMethod">
                        <option value="binance">🔶 Binance USDT</option>
                        <option value="jazzcash">📱 JazzCash</option>
                        <option value="easypaisa">💼 Easypaisa</option>
                        <option value="sadapay">💳 SadaPay</option>
                        <option value="nayapay">🏦 NayaPay</option>
                        <option value="bank">🏛️ Bank Transfer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Account Details (e.g., Number, IBAN, USDT Address)</label>
                    <input type="text" id="accountDetails" placeholder="Enter account details">
                </div>
                
                <div class="form-group">
                    <label>Amount in Points (Min: 200,000 ≈ $10)</label>
                    <input type="number" id="withdrawAmount" placeholder="200000" min="200000">
                </div>
                
                <button class="btn" onclick="requestWithdrawal()" id="withdrawalBtn">💸 Request Withdrawal</button>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">💼 My Withdrawal History</h3>
                    <div id="transactionHistory">Your history will appear here.</div>
                </div>
            </div>

            <!-- NEW Leaderboard Tab -->
            <div id="leaderboard" class="tab-content hidden">
                <h2 style="text-align: center; margin-bottom: 30px;">🏆 Leaderboards</h2>
                <div class="leaderboard-container">
                    <div class="leaderboard-section">
                        <h3>💎 Top 10 Gifters (Wealth)</h3>
                        <ol id="topGiftersList" class="leaderboard-list">
                            <p style="text-align:center; opacity: 0.7;">Loading...</p>
                        </ol>
                    </div>
                    <div class="leaderboard-section">
                        <h3>💖 Top 10 Receivers (Charm)</h3>
                        <ol id="topReceiversList" class="leaderboard-list">
                            <p style="text-align:center; opacity: 0.7;">Loading...</p>
                        </ol>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- NEW VOICE ROOM UI -->
    <div id="voiceRoomView" class="voice-room-view">
        <div class="voice-room-header">
            <h2 id="voiceRoomName">Room Name</h2>
            <p id="voiceRoomHost">Hosted by: </p>
        </div>
        <div class="voice-room-main">
            <div class="voice-room-seats-container">
                <div id="voiceRoomSeatsGrid" class="voice-room-seats-grid">
                    <!-- Seats will be dynamically generated here -->
                </div>
            </div>
            <div class="voice-room-chat-panel">
                <div class="messages" id="voiceRoomChatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="voiceRoomMessageInput" placeholder="Chat in room..." onkeypress="handleVoiceRoomEnter(event)">
                    <button class="send-btn" onclick="sendVoiceRoomMessage()" title="Send">▶</button>
                </div>
            </div>
        </div>
        <div class="voice-room-controls">
            <button id="voiceRoomMuteBtn" class="btn" style="width: auto; min-width: 120px;" onclick="toggleVoiceRoomMute()">🎙️ Unmute</button>
            <button class="btn btn-danger" style="width: auto; min-width: 120px;" onclick="leaveVoiceRoom()">🚪 Leave</button>
        </div>
    </div>


    <!-- Gift Modal -->
    <div id="giftModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGiftModal()">&times;</span>
            <div style="text-align: center;">
                <h2 style="margin-bottom: 10px;">🎁 Send a Gift</h2>
                <p>To: <span id="giftRecipient" style="font-weight: bold;"></span></p>
            </div>
            <div class="modal-body">
                <div class="gifts-grid" id="giftsGrid"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="sendGift()" id="sendGiftBtn" disabled>Select a gift to send</button>
            </div>
        </div>
    </div>
    
    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreatePostModal()">&times;</span>
            <div style="text-align: center;">
                <h2 style="margin-bottom: 20px;">Create a New Post</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="postText">What's on your mind?</label>
                    <textarea id="postText" rows="4" placeholder="Share something with the community..."></textarea>
                </div>
                <div class="form-group">
                    <label for="postImageInput">Add an Image (Optional)</label>
                    <input type="file" id="postImageInput" accept="image/*" style="padding: 10px; background: rgba(0,0,0,0.2);">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="createPost()" id="createPostBtn">🚀 Share Post</button>
            </div>
        </div>
    </div>

    <!-- NEW Create Video Modal -->
    <div id="createVideoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateVideoModal()">&times;</span>
            <div style="text-align: center;">
                <h2 style="margin-bottom: 20px;">Upload a New Video</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="videoCaption">Add a caption</label>
                    <textarea id="videoCaption" rows="3" placeholder="Describe your video..."></textarea>
                </div>
                <div class="form-group">
                    <label for="videoFileInput">Select a Video</label>
                    <input type="file" id="videoFileInput" accept="video/*" style="padding: 10px; background: rgba(0,0,0,0.2);">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="createVideo()" id="createVideoBtn">🎬 Upload Video</button>
            </div>
        </div>
    </div>

    <!-- NEW Create Voice Room Modal -->
    <div id="createVoiceRoomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateVoiceRoomModal()">&times;</span>
            <div style="text-align: center;">
                <h2 style="margin-bottom: 20px;">Create a Voice Room</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newRoomName">Room Name</label>
                    <input type="text" id="newRoomName" placeholder="e.g., Chill Zone">
                </div>
                <div class="form-group">
                    <label for="newRoomSeats">Number of Seats</label>
                    <select id="newRoomSeats">
                        <option value="4">4 Seats</option>
                        <option value="6">6 Seats</option>
                        <option value="9" selected>9 Seats</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="createVoiceRoom()" id="createVoiceRoomBtn">🚀 Create Room</button>
            </div>
        </div>
    </div>
    
    <!-- Gift Sound Effects Container -->
    <div id="audio-container" style="display: none;">
        <audio id="sound-kiss" src="https://assets.mixkit.co/sfx/preview/mixkit-hard-kiss-2589.mp3"></audio>
        <audio id="sound-rose" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-chime-2613.mp3"></audio>
        <audio id="sound-eggs" src="https://assets.mixkit.co/sfx/preview/mixkit-egg-cracking-1274.mp3"></audio>
        <audio id="sound-applause" src="https://assets.mixkit.co/sfx/preview/mixkit-conference-audience-clapping-479.mp3"></audio>
        <audio id="sound-lollipop" src="https://assets.mixkit.co/sfx/preview/mixkit-hard-pop-click-2364.mp3"></audio>
        <audio id="sound-lucky_star" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
        <audio id="sound-bubble_gun" src="https://assets.mixkit.co/sfx/preview/mixkit-water-bubbles-1304.mp3"></audio>
        <audio id="sound-crystal_shoes" src="https://assets.mixkit.co/sfx/preview/mixkit-shimmering-bling-shine-435.mp3"></audio>
        <audio id="sound-crystal" src="https://assets.mixkit.co/sfx/preview/mixkit-bonus-earned-in-video-game-2058.mp3"></audio>
        <audio id="sound-pizza" src="https://assets.mixkit.co/sfx/preview/mixkit-eating-a-crunchy-bite-2244.mp3"></audio>
        <audio id="sound-fruit_platter" src="https://assets.mixkit.co/sfx/preview/mixkit-human-eating-a-snack-1200.mp3"></audio>
        <audio id="sound-grapes" src="https://assets.mixkit.co/sfx/preview/mixkit-human-eating-a-snack-1200.mp3"></audio>
        <audio id="sound-cherry" src="https://assets.mixkit.co/sfx/preview/mixkit-hard-pop-click-2364.mp3"></audio>
        <audio id="sound-14 August" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-win-video-game-notification-2692.mp3"></audio>
        <audio id="sound-ring" src="https://assets.mixkit.co/sfx/preview/mixkit-bonus-earned-in-video-game-2058.mp3"></audio>
        <audio id="sound-heart" src="https://assets.mixkit.co/sfx/preview/mixkit-long-heartbeat-442.mp3"></audio>
        <audio id="sound-crown" src="https://assets.mixkit.co/sfx/preview/mixkit-trumpet-fanfare-1927.mp3"></audio>
        <audio id="sound-car" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-car-driving-away-1593.mp3"></audio>
        <audio id="sound-castle" src="https://assets.mixkit.co/sfx/preview/mixkit-game-level-completed-2059.mp3"></audio>
        <audio id="sound-lion" src="https://assets.mixkit.co/sfx/preview/mixkit-lion-roar-22449.mp3"></audio>
        <!-- ADDED: Sound for sending a message -->
        <audio id="sound-message-sent" src="https://jumpshare.com/s/xV3HtDwCuBolbuxWRtxp"></audio>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update, get, serverTimestamp, query, orderByChild, limitToLast, onDisconnect, equalTo, runTransaction, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdhjt0LLkt1Stg1PAIggjVGbwCHFPQdjY",
            authDomain: "chat-app-affb3.firebaseapp.com",
            databaseURL: "https://chat-app-affb3-default-rtdb.firebaseio.com",
            projectId: "chat-app-affb3",
            storageBucket: "chat-app-affb3.appspot.com",
            messagingSenderId: "1000455114616",
            appId: "1:1000455114616:web:980f46c6264edc44b0c28d"
        };
        
        // --- INITIALIZE FIREBASE & SERVICES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- CLOUDINARY CONFIGURATION ---
        const CLOUDINARY_CLOUD_NAME = "dh9sla4yo"; 
        const CLOUDINARY_UPLOAD_PRESET = "lwpeptx1";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;


        // --- GLOBAL STATE & CONSTANTS ---
        let currentUser = null;
        let currentUserData = null;
        let activeTab = 'login';
        let onlineUsers = {};
        let allUsersData = {};
        let currentPrivateChatPartner = null;
        let globalChatListener = null;
        let privateChatListener = null;
        let userInboxListener = null; 
        let lastKnownInboxState = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let postsListener = null;
        let videosListener = null;
        let giftTarget = { type: null, id: null, authorId: null };
        let voiceRoomsListener = null;
        let currentVoiceRoomListener = null;
        let currentVoiceRoomId = null;
        
        // --- START OF WEBRTC IMPLEMENTATION ---
        let localStream = null; // Apne microphone ki stream
        let peerConnections = {}; // Doosre users se saare connections
        let signalingListeners = {}; // Offers/Answers ke liye listeners
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        // --- END OF WEBRTC IMPLEMENTATION ---


        // --- UNIFIED LEVEL DATA (for both Wealth and Charm) ---
        const LEVEL_DATA = [
            { level: 1, cost: 0 }, { level: 2, cost: 3000 }, { level: 3, cost: 6000 },
            { level: 4, cost: 16000 }, { level: 5, cost: 66000 }, { level: 6, cost: 166000 },
            { level: 7, cost: 330000 }, { level: 8, cost: 500000 }, { level: 9, cost: 700000 },
            { level: 10, cost: 1000000 }, { level: 11, cost: 1100000 }, { level: 12, cost: 1300000 },
            { level: 13, cost: 1600000 }, { level: 14, cost: 2000000 }, { level: 15, cost: 2600000 },
            { level: 16, cost: 3400000 }, { level: 17, cost: 4400000 }, { level: 18, cost: 5600000 },
            { level: 19, cost: 7000000 }, { level: 20, cost: 10000000 }, { level: 21, cost: 10500000 },
            { level: 22, cost: 11500000 }, { level: 23, cost: 13000000 }, { level: 24, cost: 15000000 },
            { level: 25, cost: 18000000 }, { level: 26, cost: 22000000 }, { level: 27, cost: 27000000 },
            { level: 28, cost: 33000000 }, { level: 29, cost: 40000000 }, { level: 30, cost: 50000000 },
            { level: 31, cost: 52000000 }, { level: 32, cost: 55000000 }, { level: 33, cost: 60000000 },
            { level: 34, cost: 68000000 }, { level: 35, cost: 79000000 }, { level: 36, cost: 95000000 },
            { level: 37, cost: 114000000 }, { level: 38, cost: 137000000 }, { level: 39, cost: 163000000 },
            { level: 40, cost: 200000000 }, { level: 41, cost: 204000000 }, { level: 42, cost: 210000000 },
            { level: 43, cost: 220000000 }, { level: 44, cost: 236000000 }, { level: 45, cost: 258000000 },
            { level: 46, cost: 290000000 }, { level: 47, cost: 328000000 }, { level: 48, cost: 375000000 },
            { level: 49, cost: 428000000 }, { level: 50, cost: 500000000 }, { level: 51, cost: 506000000 },
            { level: 52, cost: 516000000 }, { level: 53, cost: 535000000 }, { level: 54, cost: 560000000 },
            { level: 55, cost: 598000000 }, { level: 56, cost: 648000000 }, { level: 57, cost: 710000000 },
            { level: 58, cost: 785000000 }, { level: 59, cost: 870000000 }, { level: 60, cost: 1000000000 },
            { level: 61, cost: 1020000000 }, { level: 62, cost: 1060000000 }, { level: 63, cost: 1120000000 },
            { level: 64, cost: 1220000000 }, { level: 65, cost: 1360000000 }, { level: 66, cost: 1560000000 },
            { level: 67, cost: 1800000000 }, { level: 68, cost: 2100000000 }, { level: 69, cost: 2440000000 },
            { level: 70, cost: 3000000000 }, { level: 71, cost: 3020000000 }, { level: 72, cost: 3060000000 },
            { level: 73, cost: 3120000000 }, { level: 74, cost: 3220000000 }, { level: 75, cost: 3360000000 },
            { level: 76, cost: 3560000000 }, { level: 77, cost: 3800000000 }, { level: 78, cost: 4100000000 },
            { level: 79, cost: 4440000000 }, { level: 80, cost: 5000000000 }, { level: 81, cost: 5050000000 },
            { level: 82, cost: 5150000000 }, { level: 83, cost: 5300000000 }, { level: 84, cost: 5550000000 },
            { level: 85, cost: 5900000000 }, { level: 86, cost: 6400000000 }, { level: 87, cost: 7000000000 },
            { level: 88, cost: 7750000000 }, { level: 89, cost: 8600000000 }, { level: 90, cost: 10000000000 },
            { level: 91, cost: 10100000000 }, { level: 92, cost: 10300000000 }, { level: 93, cost: 10600000000 },
            { level: 94, cost: 11100000000 }, { level: 95, cost: 11800000000 }, { level: 96, cost: 12800000000 },
            { level: 97, cost: 14000000000 }, { level: 98, cost: 15500000000 }, { level: 99, cost: 17200000000 },
            { level: 100, cost: 20600000000 }
        ];
        
        // --- SYSTEM CONSTANTS ---
        const OWNER_REVENUE_SHARE = 0.30;
        const MESSAGE_COST = 10;
        const GIRL_MSG_REWARD = 7; // 10 coins cost - 3 (30%) commission = 7
        const WITHDRAWAL_MIN = 200000;

        // --- NEW REFERRAL SYSTEM CONSTANTS ---
        const REFERRAL_UNLOCK_POINTS = 10000;
        const REFERRAL_CHAIN_REWARDS = [3000, 2500, 2000, 1500, 1000]; // Level 1 to 5

        // --- GIFT DATA ---
        const GIFTS = [
            { id: 'kiss', name: 'Kiss', icon: '💋', price: 100, isLucky: true }, { id: 'rose', name: 'Rose', icon: '🌹', price: 100, isLucky: true }, { id: 'eggs', name: 'Eggs', icon: '🥚', price: 120, isLucky: false }, { id: 'cheer_stick', name: 'Cheer Stick', icon: '✨', price: 120, isLucky: false }, { id: 'applause', name: 'Applause', icon: '👏', price: 200, isLucky: true }, { id: 'lollipop', name: 'Lollipop', icon: '🍭', price: 250, isLucky: true }, { id: 'lucky_star', name: 'Lucky Star', icon: '🌟', price: 500, isLucky: true }, { id: 'diamond_heart', name: 'Diamond Heart', icon: '💖', price: 600, isLucky: false }, { id: 'bubble_gun', name: 'Bubble Gun', icon: '🔫', price: 2000, isLucky: true }, { id: 'crystal_shoes', name: 'Crystal Shoes', icon: '👠', price: 2000, isLucky: true }, { id: 'crystal', name: 'Crystal', icon: '💎', price: 2000, isLucky: true }, { id: 'pizza', name: 'Pizza', icon: '🍕', price: 2400, isLucky: true }, { id: 'fruit_platter', name: 'Fruit Platter', icon: '🍉', price: 2400, isLucky: true }, { id: 'grapes', name: 'Grapes', icon: '🍇', price: 2400, isLucky: false }, { id: 'cherry', name: 'Cherry', icon: '🍒', price: 12000, isLucky: false }, { id: '14 August', name: '14 August', icon: '🇵🇰', price: 250, isLucky: false }, { id: 'ring', name: 'Ring', icon: '💍', price: 500, isLucky: false }, { id: 'heart', name: 'Heart', icon: '❤️', price: 1000, isLucky: false }, { id: 'crown', name: 'Crown', icon: '👑', price: 5000, isLucky: false }, { id: 'car', name: 'Sports Car', icon: '🏎️', price: 50000, isLucky: false }, { id: 'castle', name: 'Castle', icon: '🏰', price: 100000, isLucky: false }, { id: 'lion', name: 'Lion', icon: '🦁', price: 200000, isLucky: false }
        ];

        // --- NEW: FRAME DATA ---
        const FRAMES = [
            // Static Frames
            { id: 'static_gold_1', name: 'Golden Wreath', price: 5000, type: 'static', imageUrl: 'https://iili.io/FZ3rEu4.png' },
            { id: 'static_silver_1', name: 'Silver Ornate', price: 7500, type: 'static', imageUrl: 'https://iili.io/FZ3OaVa.png' },
            { id: 'static_neon_1', name: 'Mystic Bloom', price: 15000, type: 'static', imageUrl: 'https://iili.io/FZ2gTMX.png' },
            { id: 'static_gem_1', name: 'Gemstone Border', price: 50000, type: 'static', imageUrl: 'https://iili.io/FZ2hzRn.png' },
            { id: 'static_royal_1', name: 'Royal Crest', price: 100000, type: 'static', imageUrl: 'https://iili.io/FZ3Sa3b.png' },
            // Animated Frames
            { id: 'anim_fire_1', name: 'Blazing Halo', price: 10000, type: 'animated', imageUrl: 'https://media4.giphy.com/media/v1.Y2lkPTZjMDliOTUyZ3RmdDVyZjJsdWJoanVsYnlkMWQ1cW8zejhpc2R2aGloYmVjZmUxZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/hi63f9Si1eFrHuXBz5/giphy.gif' },
            { id: 'anim_sparkle_1', name: 'Royal Glow', price: 25000, type: 'animated', imageUrl: 'https://media1.giphy.com/media/v1.Y2lkPTZjMDliOTUydDRxbDhkc200Z3A4MHN3azJjNm1yMGpseWhwZjNmNG9maG92OGU5dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/91C1sKliu2jt6w9rt4/giphy.gif' },
            { id: 'anim_galaxy_1', name: 'Cosmic Twirl', price: 60000, type: 'animated', imageUrl: 'https://media0.giphy.com/media/v1.Y2lkPTZjMDliOTUyOW40dmkyM3NrbTMya29uNnFmNzZobm1rc2Y2ZXExdnVtMHBhazhvMiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/cwlU7SYQbx3quBusa5/giphy.gif' },
            { id: 'anim_electric_1', name: 'Love Voltage', price: 120000, type: 'animated', imageUrl: 'https://media0.giphy.com/media/v1.Y2lkPTZjMDliOTUyNTRmeW8zdndqY2dnaTRoN3hhNGF0cXNxb3M2OTExdHdmMTc2ZjlqbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/Uq3HZ0usX6o6QOC3Yk/giphy.gif' }
        ];

        // --- UI ELEMENT GETTERS ---
        const UIElements = {
            mainHeader: document.getElementById('main-header'),
            userDisplay: document.getElementById('userDisplay'),
            coinsDisplay: document.getElementById('coinsDisplay'),
            pointsDisplay: document.getElementById('pointsDisplay'),
            onlineUsersDisplay: document.getElementById('onlineUsersDisplay'),
            inboxTabBtn: document.getElementById('inboxTabBtn'), 
            globalMessages: document.getElementById('globalMessages'),
            privateMessages: document.getElementById('privateMessages'),
            privateChatHeader: document.getElementById('privateChatHeader'),
            sendPrivateBtn: document.getElementById('sendPrivateBtn'),
            usersList: document.getElementById('usersList'),
            profileInfo: document.getElementById('profileInfo'),
            myReferralCode: document.getElementById('myReferralCode'),
            profileMobileNumber: document.getElementById('profileMobileNumber'),
            profilePoints: document.getElementById('profilePoints'),
            dailyRewardBtn: document.getElementById('dailyRewardBtn'),
            dailyRewardCoins: document.getElementById('dailyRewardCoins'),
            giftModal: document.getElementById('giftModal'),
            giftRecipient: document.getElementById('giftRecipient'),
            giftsGrid: document.getElementById('giftsGrid'),
            sendGiftBtn: document.getElementById('sendGiftBtn'),
            transactionHistory: document.getElementById('transactionHistory'),
            withdrawalBtn: document.getElementById('withdrawalBtn'),
            profileUsername: document.getElementById('profileUsername'),
            profileDisplayName: document.getElementById('profileDisplayName'),
            editProfileBtn: document.getElementById('editProfileBtn'),
            profileEditActions: document.getElementById('profileEditActions'),
            createPostModal: document.getElementById('createPostModal'),
            postsFeed: document.getElementById('posts-feed'),
            createVideoModal: document.getElementById('createVideoModal'),
            videosFeed: document.getElementById('videos-feed'),
            createVoiceRoomModal: document.getElementById('createVoiceRoomModal')
        };
        
        // --- UNIFIED FUNCTION TO CALCULATE LEVEL (Wealth or Charm) ---
        const calculateLevel = (totalPoints) => {
            if (typeof totalPoints !== 'number' || totalPoints < 0) {
                totalPoints = 0;
            }
            for (let i = LEVEL_DATA.length - 1; i >= 0; i--) {
                const levelInfo = LEVEL_DATA[i];
                if (totalPoints >= levelInfo.cost) {
                    const nextLevelInfo = LEVEL_DATA[i + 1];
                    return {
                        level: levelInfo.level,
                        currentPoints: totalPoints,
                        costForCurrentLevel: levelInfo.cost,
                        costForNextLevel: nextLevelInfo ? nextLevelInfo.cost : levelInfo.cost,
                    };
                }
            }
            return { level: 1, currentPoints: 0, costForCurrentLevel: 0, costForNextLevel: LEVEL_DATA[1].cost };
        };

        // --- ROBUSTNESS: Re-attach listener on tab visibility change ---
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentUser) {
                if (activeTab === 'globalChat') {
                    console.log('Tab became visible, refreshing global chat listener.');
                    loadGlobalChat();
                }
            }
        });

        // --- AUTHENTICATION & PROFILE MANAGEMENT ---
        
        window.showEmailSignupView = (show) => {
            document.getElementById('login').classList.toggle('hidden', show);
            document.getElementById('emailSignup').classList.toggle('hidden', !show);
        };

        window.signInWithEmail = async () => {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            if (!email || !password) return showNotification('Please enter both email and password.', 'error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification('Signing in...', 'info');
            } catch (error) {
                console.error("Email Sign-In Error:", error);
                let message = 'Sign-in failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') message = 'Invalid email or password.';
                else if (error.code === 'auth/invalid-email') message = 'Please enter a valid email address.';
                showNotification(message, 'error');
            }
        };

        window.signUpWithEmail = async () => {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();
            if (!email || !password || !confirmPassword) return showNotification('Please fill all fields.', 'error');
            if (password.length < 6) return showNotification('Password must be at least 6 characters long.', 'error');
            if (password !== confirmPassword) return showNotification('Passwords do not match.', 'error');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification('Account created! Please complete your profile.', 'info');
            } catch (error) {
                console.error("Email Sign-Up Error:", error);
                let message = 'Sign-up failed.';
                if (error.code === 'auth/email-already-in-use') message = 'This email address is already registered.';
                else if (error.code === 'auth/invalid-email') message = 'Please enter a valid email address.';
                else if (error.code === 'auth/weak-password') message = 'Password is too weak.';
                showNotification(message, 'error');
            }
        };

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showNotification(`Google Sign-In Failed: ${error.message}`, 'error');
            }
        };
        
        async function isUsernameTaken(username) {
            const usersRef = ref(db, 'users');
            const usernameQuery = query(usersRef, orderByChild('username'), equalTo(username));
            const snapshot = await get(usernameQuery);
            return snapshot.exists();
        }

        async function findUserByUsername(username) {
            const usersRef = ref(db, 'users');
            const usernameQuery = query(usersRef, orderByChild('username'), equalTo(username));
            const snapshot = await get(usernameQuery);
            if (snapshot.exists()) {
                const userData = snapshot.val();
                const uid = Object.keys(userData)[0];
                return { uid, ...userData[uid] };
            }
            return null;
        }

        window.registerNewUser = async () => {
            if (!currentUser) return showNotification('Authentication error. Please try signing in again.', 'error');

            const regButton = document.getElementById('completeRegBtn');
            regButton.disabled = true;
            regButton.textContent = 'Processing...';

            const fullName = document.getElementById('regFullName').value.trim();
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const age = document.getElementById('regAge').value;
            const mobileNumber = document.getElementById('regMobileNumber').value.trim();
            const gender = document.getElementById('regGender').value;
            const country = document.getElementById('regCountry').value;
            const referralCode = document.getElementById('regReferralCode').value.trim().toLowerCase();
            const email = currentUser.email;

            if (!fullName || !username || !age || !mobileNumber || !gender || !country) {
                showNotification('Please fill out all fields.', 'error');
                regButton.disabled = false; regButton.textContent = '🚀 Complete Registration'; return;
            }
            if (!/^[a-z0-9_.]+$/.test(username)) {
                showNotification('Username can only contain lowercase letters, numbers, dots, and underscores.', 'error');
                regButton.disabled = false; regButton.textContent = '🚀 Complete Registration'; return;
            }
            if (await isUsernameTaken(username)) {
                showNotification('This username is already taken. Please choose another one.', 'error');
                regButton.disabled = false; regButton.textContent = '🚀 Complete Registration'; return;
            }
            
            regButton.textContent = 'Verifying Details...';
            let referredByUid = null;
            if (referralCode) {
                if (referralCode === username) {
                    showNotification('You cannot refer yourself.', 'error');
                    regButton.disabled = false; regButton.textContent = '🚀 Complete Registration'; return;
                }
                const referrer = await findUserByUsername(referralCode);
                if (referrer) {
                    referredByUid = referrer.uid;
                    showNotification(`Referred by ${referrer.displayName}!`, 'info');
                } else {
                    showNotification('Invalid referral code. Registration will continue without a referrer.', 'info');
                }
            }
            regButton.textContent = 'Creating Profile...';

            try {
                const userRef = ref(db, `users/${currentUser.uid}`);
                const userData = {
                    uid: currentUser.uid, displayName: fullName, username: username, photoURL: currentUser.photoURL || null, age: parseInt(age), email: email, mobileNumber: mobileNumber, userType: gender, country: country, coins: 1000, points: 0, giftingSpend: 0, charmPoints: 0, createdAt: serverTimestamp(), lastLogin: serverTimestamp(), isOnline: true, referralCode: username, lastDailyReward: 0, role: 'user', isBanned: false, hasChangedName: false, hasChangedNumber: false,
                    earnedPoints: 0, referralUnlocked: false,
                    // NEW: Frame data
                    ownedFrames: {},
                    equippedFrame: null
                };
                if (referredByUid) userData.referredBy = referredByUid;
                await set(userRef, userData);
                showNotification('Profile created successfully! Welcome!', 'success');
                setupLoggedInState(currentUser.uid);
            } catch (error) {
                console.error("Profile Creation Error:", error);
                showNotification(`Profile creation failed: ${error.message}`, 'error');
                regButton.disabled = false; regButton.textContent = '🚀 Complete Registration';
            }
        };

        // --- NEW: REFERRAL CHAIN PROCESSING ---
        async function processReferralChain(unlockedByUserId) {
            console.log(`Processing referral chain for user: ${unlockedByUserId}`);
            await update(ref(db, `users/${unlockedByUserId}`), { referralUnlocked: true });
            
            let currentUserId = unlockedByUserId;
            for (let level = 0; level < REFERRAL_CHAIN_REWARDS.length; level++) {
                const userSnapshot = await get(ref(db, `users/${currentUserId}`));
                if (!userSnapshot.exists()) {
                    console.log(`Chain broken at user ${currentUserId} (does not exist).`);
                    break;
                }
                const userData = userSnapshot.val();
                const parentId = userData.referredBy;

                if (parentId) {
                    const rewardAmount = REFERRAL_CHAIN_REWARDS[level];
                    await runTransaction(ref(db, `users/${parentId}/points`), (points) => (points || 0) + rewardAmount);
                    await push(ref(db, 'referral_logs'), {
                        unlockedBy: unlockedByUserId, rewardedUser: parentId, level: level + 1, amount: rewardAmount, timestamp: serverTimestamp()
                    });
                    console.log(`Level ${level + 1}: Rewarded ${parentId} with ${rewardAmount} points.`);
                    currentUserId = parentId;
                } else {
                    console.log(`Referral chain ended at level ${level + 1}.`);
                    break;
                }
            }
            showNotification('Referral chain unlocked! Rewards have been distributed.', 'success');
        }

        async function checkAndTriggerReferral(userId) {
            const userRef = ref(db, `users/${userId}`);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                const userData = snapshot.val();
                if ((userData.earnedPoints || 0) >= REFERRAL_UNLOCK_POINTS && !userData.referralUnlocked) {
                    await processReferralChain(userId);
                }
            }
        }


        window.toggleProfileEditMode = (isEditing) => {
            UIElements.profileDisplayName.readOnly = !isEditing;
            UIElements.profileMobileNumber.readOnly = !isEditing;
            UIElements.editProfileBtn.classList.toggle('hidden', isEditing);
            UIElements.profileEditActions.classList.toggle('hidden', !isEditing);
            document.querySelectorAll('.edit-note').forEach(note => note.classList.toggle('hidden', !isEditing));
            if (!isEditing) updateUIForUser();
        };
        
        window.saveProfileChanges = async () => {
            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true; saveBtn.textContent = 'Saving...';

            const newDisplayName = UIElements.profileDisplayName.value.trim();
            const newMobileNumber = UIElements.profileMobileNumber.value.trim();

            if (!newDisplayName || !newMobileNumber) {
                showNotification('Display name and mobile number cannot be empty.', 'error');
                saveBtn.disabled = false; saveBtn.textContent = '💾 Save Changes'; return;
            }
            let cost = 0; const CHANGE_COST = 10000; const updates = {}; let changesMade = false;

            if (newDisplayName !== currentUserData.displayName) {
                changesMade = true;
                if (currentUserData.hasChangedName) cost += CHANGE_COST;
                updates.displayName = newDisplayName; updates.hasChangedName = true;
            }
            if (newMobileNumber !== currentUserData.mobileNumber) {
                changesMade = true;
                if (currentUserData.hasChangedNumber) cost += CHANGE_COST;
                updates.mobileNumber = newMobileNumber; updates.hasChangedNumber = true;
            }
            if (!changesMade) {
                showNotification('No changes were made.', 'info');
                toggleProfileEditMode(false); saveBtn.disabled = false; saveBtn.textContent = '💾 Save Changes'; return;
            }
            if (cost > 0) {
                if ((currentUserData.coins || 0) < cost) {
                    showNotification(`You need ${cost.toLocaleString()} coins to make these changes.`, 'error');
                    saveBtn.disabled = false; saveBtn.textContent = '💾 Save Changes'; return;
                }
                updates.coins = (currentUserData.coins || 0) - cost;
            }
            try {
                await update(ref(db, `users/${currentUser.uid}`), updates);
                let successMessage = 'Profile updated successfully!';
                if (cost > 0) successMessage += ` ${cost.toLocaleString()} coins were deducted.`;
                showNotification(successMessage, 'success');
                toggleProfileEditMode(false);
            } catch (error) {
                showNotification(`Error updating profile: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false; saveBtn.textContent = '💾 Save Changes';
            }
        };
        
        window.handleProfilePicUpload = async (event) => {
            const file = event.target.files[0]; if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showNotification('File is too large. Max 5MB.', 'error');
            if (!file.type.startsWith('image/')) return showNotification('Please select a valid image file.', 'error');
            showNotification('Uploading new profile picture...', 'info');
            const formData = new FormData();
            formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) {
                    await update(ref(db, `users/${currentUser.uid}`), { photoURL: data.secure_url });
                    showNotification('Profile picture updated successfully!', 'success');
                } else { throw new Error(data.error?.message || 'Unknown Cloudinary error'); }
            } catch (error) {
                console.error("Profile Pic Upload Error:", error);
                showNotification(`Upload failed: ${error.message}`, 'error');
            } finally {
                event.target.value = ''; 
            }
        };


        window.logout = async () => {
            if (!currentUser) return;
            // Detach all listeners
            if (globalChatListener) { globalChatListener(); globalChatListener = null; }
            if (privateChatListener) { privateChatListener(); privateChatListener = null; }
            if (userInboxListener) {  userInboxListener(); userInboxListener = null; }
            if (postsListener) { postsListener(); postsListener = null; }
            if (videosListener) { videosListener(); videosListener = null; }
            if (voiceRoomsListener) { voiceRoomsListener(); voiceRoomsListener = null; }
            if (currentVoiceRoomId) await leaveVoiceRoom(); // Gracefully leave voice room on logout

            window.OneSignalDeferred.push(function(OneSignal) { OneSignal.logout().then(() => console.log("OneSignal user logged out.")).catch(e => console.error("OneSignal logout error:", e)); });
            const userStatusRef = ref(db, `users/${currentUser.uid}`);
            onDisconnect(userStatusRef).cancel();
            await update(userStatusRef, { isOnline: false, lastSeen: serverTimestamp() });
            await signOut(auth);
            showNotification('You have been logged out.', 'info');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    setupLoggedInState(user.uid);
                } else {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById('registration').classList.remove('hidden');
                    UIElements.mainHeader.classList.add('hidden');
                    document.getElementById('regEmail').value = user.email;
                    document.getElementById('regFullName').value = user.displayName || '';
                    showNotification('Welcome! Please complete your profile to continue.', 'info');
                }
            } else {
                currentUser = null;
                setupLoggedOutState();
            }
        });

        const setupLoggedInState = (uid) => {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('emailSignup').classList.add('hidden');
            document.getElementById('registration').classList.add('hidden');
            UIElements.mainHeader.classList.remove('hidden');
            window.OneSignalDeferred.push(function(OneSignal) { OneSignal.login(uid).then(() => console.log("OneSignal user logged in with External ID:", uid)).catch(e => console.error("OneSignal login error:", e)); });
            const userStatusRef = ref(db, `users/${uid}`);
            onDisconnect(userStatusRef).update({ isOnline: false, lastSeen: serverTimestamp() });
            update(userStatusRef, { isOnline: true, lastLogin: serverTimestamp() });
            onValue(ref(db, `users/${uid}`), (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    if (!currentUserData.username) { logout(); return; }
                    if (currentUserData.isBanned) { showNotification('Your account has been banned by an administrator.', 'error'); logout(); return; }
                    updateUIForUser();
                } else { showNotification('Your profile data could not be found. Logging out.', 'error'); logout(); }
            });
            onValue(ref(db, 'users'), (snapshot) => {
                if (snapshot.exists()) {
                    allUsersData = snapshot.val();
                    onlineUsers = Object.values(allUsersData).filter(u => u.isOnline);
                    UIElements.onlineUsersDisplay.textContent = `🟢 Online: ${onlineUsers.length}`;
                    updateUsersList();
                    if(activeTab === 'moments') loadPostsFeed();
                    if(activeTab === 'videos') loadVideosFeed();
                    if(activeTab === 'leaderboard') updateLeaderboards();
                    if(activeTab === 'earn') loadMyReferrals();
                    if(activeTab === 'shop') populateShop();
                    if(activeTab === 'voiceRooms') loadVoiceRooms();
                }
            });
            if (userInboxListener) userInboxListener();
            userInboxListener = setupInboxListener(uid); 
            loadGlobalChat(); loadWithdrawalHistory(); loadMyReferrals();
            if(activeTab === 'login' || activeTab === 'registration') showTab('globalChat');
        };

        const setupLoggedOutState = () => {
            UIElements.mainHeader.classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('login').classList.remove('hidden');
            document.getElementById('voiceRoomView').classList.remove('show'); // Ensure voice room is hidden on logout
            activeTab = 'login';
            UIElements.userDisplay.textContent = '👤 Guest';
            UIElements.coinsDisplay.textContent = '💰 Coins: 0';
            UIElements.pointsDisplay.textContent = '💎 Points: 0';
            UIElements.onlineUsersDisplay.textContent = '🟢 Online: 0';
            UIElements.globalMessages.innerHTML = '<p style="text-align:center;">Please log in to see the chat.</p>';
            UIElements.usersList.innerHTML = '<p style="text-align:center;">Please log in to see other users.</p>';
            UIElements.postsFeed.innerHTML = '<p style="text-align:center;">Please log in to see moments.</p>';
            UIElements.videosFeed.innerHTML = '<p style="text-align:center;">Please log in to see videos.</p>';
            document.getElementById('voiceRoomsList').innerHTML = '<p style="text-align:center;">Please log in to see voice rooms.</p>';
            UIElements.myReferralCode.value = ''; UIElements.profileUsername.value = ''; UIElements.profileDisplayName.value = ''; UIElements.profileMobileNumber.value = ''; UIElements.profilePoints.value = '';
            updateUsersTabIndicator(false);
        };
        
        const updateUIForUser = () => {
            if (!currentUserData) return;
            UIElements.userDisplay.textContent = `👤 ${currentUserData.displayName}`;
            UIElements.coinsDisplay.textContent = `💰 Coins: ${(currentUserData.coins || 0).toLocaleString()}`;
            UIElements.pointsDisplay.textContent = `💎 Points: ${(currentUserData.points || 0).toLocaleString()}`;
            
            // Wealth Level
            const wealthLevelData = calculateLevel(currentUserData.giftingSpend || 0);
            const wealthProgress = wealthLevelData.costForNextLevel > wealthLevelData.costForCurrentLevel ? ((wealthLevelData.currentPoints - wealthLevelData.costForCurrentLevel) / (wealthLevelData.costForNextLevel - wealthLevelData.costForCurrentLevel)) * 100 : 100;
            document.getElementById('profileWealthLevel').innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-weight: bold; font-size: 1.2rem;">LV. ${wealthLevelData.level}</span><span style="font-size: 0.9em; opacity: 0.8;">Next: LV. ${wealthLevelData.level + 1}</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${wealthProgress.toFixed(2)}%;"></div></div><div class="progress-bar-text">${(wealthLevelData.currentPoints || 0).toLocaleString()} / ${(wealthLevelData.costForNextLevel || 0).toLocaleString()} Coins Spent</div>`;

            // Charm Level
            const charmLevelData = calculateLevel(currentUserData.charmPoints || 0);
            const charmProgress = charmLevelData.costForNextLevel > charmLevelData.costForCurrentLevel ? ((charmLevelData.currentPoints - charmLevelData.costForCurrentLevel) / (charmLevelData.costForNextLevel - charmLevelData.costForCurrentLevel)) * 100 : 100;
            document.getElementById('profileCharmLevel').innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-weight: bold; font-size: 1.2rem;">LV. ${charmLevelData.level}</span><span style="font-size: 0.9em; opacity: 0.8;">Next: LV. ${charmLevelData.level + 1}</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${charmProgress.toFixed(2)}%; background: linear-gradient(90deg, #ff9ff3, #f368e0);"></div></div><div class="progress-bar-text">${(charmLevelData.currentPoints || 0).toLocaleString()} / ${(charmLevelData.costForNextLevel || 0).toLocaleString()} Points Received</div>`;

            // Referral Progress
            const referralProgressDisplay = document.getElementById('profileReferralProgress');
            if(currentUserData.referralUnlocked) {
                referralProgressDisplay.innerHTML = `<div style="text-align:center; font-weight: bold; color: #00b894;">✅ Referral Bonus Unlocked!</div>`;
            } else {
                const earned = currentUserData.earnedPoints || 0;
                const referralProgress = (earned / REFERRAL_UNLOCK_POINTS) * 100;
                referralProgressDisplay.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-weight: bold;">Unlock Goal</span><span style="font-size: 0.9em; opacity: 0.8;">For Referrer</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${referralProgress.toFixed(2)}%; background: linear-gradient(90deg, #3742fa, #2f3542);"></div></div><div class="progress-bar-text">${earned.toLocaleString()} / ${REFERRAL_UNLOCK_POINTS.toLocaleString()} Points Earned</div>`;
            }
            
            UIElements.profileDisplayName.value = currentUserData.displayName || '';
            UIElements.profileUsername.value = currentUserData.username || '';
            UIElements.myReferralCode.value = currentUserData.referralCode || '';
            UIElements.profileMobileNumber.value = currentUserData.mobileNumber || '';
            UIElements.profilePoints.value = (currentUserData.points || 0).toLocaleString();
            UIElements.profileInfo.innerHTML = createUserCardHTML(currentUserData);
            updateProfileFramesUI(); // NEW: Update the frames section
            checkDailyReward();
        };

        window.requestWithdrawal = async () => {
            const withdrawalBtn = UIElements.withdrawalBtn;
            withdrawalBtn.disabled = true; withdrawalBtn.textContent = 'Processing...';
            const method = document.getElementById('withdrawalMethod').value;
            const details = document.getElementById('accountDetails').value.trim();
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            if (!details || !amount) { withdrawalBtn.disabled = false; withdrawalBtn.textContent = '💸 Request Withdrawal'; return showNotification('Please fill all withdrawal fields.', 'error'); }
            if (amount < WITHDRAWAL_MIN) { withdrawalBtn.disabled = false; withdrawalBtn.textContent = '💸 Request Withdrawal'; return showNotification(`Minimum withdrawal amount is ${WITHDRAWAL_MIN.toLocaleString()} points.`, 'error'); }
            if ((currentUserData.points || 0) < amount) { withdrawalBtn.disabled = false; withdrawalBtn.textContent = '💸 Request Withdrawal'; return showNotification("You don't have enough points.", 'error'); }
            const updates = {};
            const newWithdrawalKey = push(ref(db, 'withdrawals')).key;
            updates[`/withdrawals/${newWithdrawalKey}`] = { userId: currentUser.uid, username: currentUserData.displayName, amount, method, details, status: 'pending', timestamp: serverTimestamp() };
            updates[`/users/${currentUser.uid}/points`] = (currentUserData.points || 0) - amount;
            try {
                await update(ref(db), updates);
                showNotification('Withdrawal request submitted successfully.', 'success');
                document.getElementById('accountDetails').value = ''; document.getElementById('withdrawAmount').value = '';
            } catch(error) {
                showNotification(`Error submitting request: ${error.message}`, 'error');
                const userRef = ref(db, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) { currentUserData = snapshot.val(); updateUIForUser(); }
            } finally {
                withdrawalBtn.disabled = false; withdrawalBtn.textContent = '💸 Request Withdrawal';
            }
        };

        const updateLeaderboards = () => {
            if (!allUsersData) return;
            const usersArray = Object.values(allUsersData).filter(u => u.username);
            const sortedGifters = [...usersArray].filter(user => user.giftingSpend > 0).sort((a, b) => (b.giftingSpend || 0) - (a.giftingSpend || 0)).slice(0, 10);
            const topGiftersList = document.getElementById('topGiftersList');
            if (sortedGifters.length > 0) {
                topGiftersList.innerHTML = sortedGifters.map(user => { const avatar = createUserAvatarHTML(user); return `<li class="leaderboard-item">${avatar ? `<div class="user-avatar">${avatar}</div>` : ''}<div class="leaderboard-item-info"><span class="name">${user.displayName}</span><span class="score">💎 Spent: ${(user.giftingSpend || 0).toLocaleString()}</span></div></li>`; }).join('');
            } else { topGiftersList.innerHTML = '<p style="text-align:center; opacity: 0.7;">No gifters yet. Be the first!</p>'; }
            const sortedReceivers = [...usersArray].filter(user => user.charmPoints > 0).sort((a, b) => (b.charmPoints || 0) - (a.charmPoints || 0)).slice(0, 10);
            const topReceiversList = document.getElementById('topReceiversList');
            if (sortedReceivers.length > 0) {
                topReceiversList.innerHTML = sortedReceivers.map(user => { const avatar = createUserAvatarHTML(user); return `<li class="leaderboard-item">${avatar ? `<div class="user-avatar">${avatar}</div>` : ''}<div class="leaderboard-item-info"><span class="name">${user.displayName}</span><span class="score">💖 Received: ${(user.charmPoints || 0).toLocaleString()}</span></div></li>`; }).join('');
            } else { topReceiversList.innerHTML = '<p style="text-align:center; opacity: 0.7;">No one has received gifts yet.</p>'; }
        };

        window.showTab = (tabName) => {
            if (!currentUser && !['login', 'registration', 'emailSignup'].includes(tabName)) return;
            if (activeTab === tabName) return;
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            const activeBtn = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            activeTab = tabName;
            
            // Cleanup previous tab's listeners if necessary
            if (postsListener) { postsListener(); postsListener = null; }
            if (videosListener) { videosListener(); videosListener = null; }
            if (voiceRoomsListener) { voiceRoomsListener(); voiceRoomsListener = null; }
            
            // Load content for the new tab
            if (tabName === 'moments') loadPostsFeed();
            else if (tabName === 'videos') loadVideosFeed();
            else if (tabName === 'leaderboard') updateLeaderboards();
            else if (tabName === 'earn') loadMyReferrals();
            else if (tabName === 'shop') populateShop();
            else if (tabName === 'voiceRooms') loadVoiceRooms();
        };
        
        const setupInboxListener = (uid) => {
            const inboxRef = ref(db, `user_inbox/${uid}`);
            return onValue(inboxRef, (snapshot) => {
                const newInboxState = snapshot.val() || {};
                document.querySelectorAll('.notification-dot').forEach(dot => dot.remove());
                updateUsersTabIndicator(false);
                let hasAnyUnread = false;
                for (const chatRoomId in newInboxState) {
                    const inboxData = newInboxState[chatRoomId];
                    if (inboxData.unread) {
                        hasAnyUnread = true;
                        const partnerId = chatRoomId.replace(uid, '').replace('_', '');
                        updateUserListNotificationIndicator(partnerId, true);
                        const lastState = lastKnownInboxState[chatRoomId];
                        if (!lastState || (lastState.timestamp < inboxData.timestamp && !lastState.unread) ) {
                            const isViewingChat = activeTab === 'privateChat' && currentPrivateChatPartner && currentPrivateChatPartner.uid === partnerId;
                            if (!isViewingChat) showNotification(`💬 New message from ${inboxData.senderName}: "${inboxData.lastMessage.substring(0, 40)}..."`, 'info');
                        }
                    }
                }
                updateUsersTabIndicator(hasAnyUnread);
                lastKnownInboxState = newInboxState;
            });
        };

        const updateUserListNotificationIndicator = (partnerId, show) => {
            const userCard = document.getElementById(`user-card-${partnerId}`);
            if (userCard) {
                let dot = userCard.querySelector('.notification-dot');
                if (show && !dot) {
                    dot = document.createElement('span'); dot.className = 'notification-dot';
                    dot.style.cssText = `position: absolute; top: 15px; right: 15px; width: 12px; height: 12px; background-color: #ff3838; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px #ff3838; z-index: 10;`;
                    userCard.appendChild(dot);
                } else if (!show && dot) dot.remove();
            }
        };

        const updateUsersTabIndicator = (show) => {
            let indicator = UIElements.inboxTabBtn.querySelector('.tab-indicator');
            if (show && !indicator) {
                indicator = document.createElement('span'); indicator.className = 'tab-indicator'; indicator.textContent = '●';
                indicator.style.cssText = `color: #ff3838; margin-left: 8px; font-size: 10px; vertical-align: super;`;
                UIElements.inboxTabBtn.appendChild(indicator);
            } else if (!show && indicator) indicator.remove();
        }
        
        const createMessageHTML = (msg, selfUid) => {
            const isOwn = msg.senderId === selfUid, isSystem = msg.type === 'system';
            if (isSystem) return `<div class="message-wrapper system"><div class="message system"><div class="message-text">${msg.text}</div></div></div>`;
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let messageContentHTML = '';
            switch(msg.type) {
                case 'image': messageContentHTML = `<img src="${msg.content}" alt="Sent image" onclick="window.open('${msg.content}', '_blank')" />`; break;
                case 'audio': messageContentHTML = `<audio controls src="${msg.content}"></audio>`; break;
                default: const tempDiv = document.createElement('div'); tempDiv.textContent = msg.text; messageContentHTML = tempDiv.innerHTML; break;
            }
            const senderData = allUsersData[msg.senderId];
            const avatarContent = senderData ? createUserAvatarHTML(senderData) : `<span>${(msg.senderName || 'U').charAt(0).toUpperCase()}</span>`; // Use helper
            const avatarClickAction = !isOwn && activeTab === 'globalChat' ? `onclick="openGiftModalForGlobalChatUser('${msg.senderId}')" title="Send a gift to ${msg.senderName}" style="cursor:pointer;"` : '';
            return `<div class="message-wrapper ${isOwn ? 'own' : 'other'}"><div class="message-avatar" ${avatarClickAction}>${avatarContent}</div><div class="message ${isOwn ? 'own' : 'other'}"><div class="message-header">${msg.senderName} <span style="opacity: 0.7; font-weight: normal;">- ${time}</span></div><div class="message-text">${messageContentHTML}</div></div></div>`;
        };

        const scrollToBottom = (element) => { element.scrollTop = element.scrollHeight; };

        window.sendGlobalTextMessage = () => {
            const input = document.getElementById('globalMessageInput'); const text = input.value.trim(); if (text === '' || !currentUserData) return;
            push(ref(db, 'global_chat'), { type: 'text', text, senderId: currentUser.uid, senderName: currentUserData.displayName, timestamp: serverTimestamp() });
            const soundElement = document.getElementById('sound-message-sent'); if (soundElement) { soundElement.currentTime = 0; soundElement.play().catch(e => {}); }
            input.value = '';
        };

        window.handleGlobalEnter = (event) => { if (event.key === 'Enter') sendGlobalTextMessage(); };

        const loadGlobalChat = () => {
            if (globalChatListener) { globalChatListener(); globalChatListener = null; }
            const messagesRef = query(ref(db, 'global_chat'), limitToLast(100));
            globalChatListener = onValue(messagesRef, (snapshot) => {
                if (!currentUser) return; let messagesHtml = '';
                if (snapshot.exists()) { snapshot.forEach(child => { const msg = child.val(); if (!msg.type && msg.text) msg.type = 'text'; messagesHtml += createMessageHTML(msg, currentUser.uid); });
                } else messagesHtml = '<p style="text-align:center;">No messages yet. Be the first to say something!</p>';
                UIElements.globalMessages.innerHTML = messagesHtml; scrollToBottom(UIElements.globalMessages);
            });
        };

        window.startPrivateChat = (targetUserId) => {
            if (targetUserId === currentUser.uid) return showNotification("You can't chat with yourself.", 'info');
            currentPrivateChatPartner = allUsersData[targetUserId]; if (!currentPrivateChatPartner) return showNotification("User not found.", 'error');
            const chatRoomId = getPrivateChatRoomId(currentUser.uid, targetUserId);
            update(ref(db, `user_inbox/${currentUser.uid}/${chatRoomId}`), { unread: false });
            if (privateChatListener) privateChatListener();
            const messagesRef = query(ref(db, `private_chats/${chatRoomId}`), limitToLast(100));
            privateChatListener = onValue(messagesRef, (snapshot) => {
                let messagesHtml = '';
                if(snapshot.exists()) { snapshot.forEach(child => { const msg = child.val(); if (!msg.type && msg.text) msg.type = 'text'; messagesHtml += createMessageHTML(msg, currentUser.uid); });
                } else messagesHtml = `<p style="text-align:center">This is the beginning of your conversation.</p>`;
                UIElements.privateMessages.innerHTML = messagesHtml; scrollToBottom(UIElements.privateMessages);
            });
            UIElements.privateChatHeader.textContent = `📱 Private Chat with ${currentPrivateChatPartner.displayName}`;
            const costText = `(${MESSAGE_COST} coins)`;
            UIElements.sendPrivateBtn.title = currentUserData.userType === 'boy' && currentPrivateChatPartner.userType === 'girl' ? `Send Message ${costText}` : 'Send Message (Free)';
            document.getElementById('privateMessageInput').placeholder = currentUserData.userType === 'boy' && currentPrivateChatPartner.userType === 'girl' ? `Type your message... ${costText}` : `Type your message...`;
            showTab('privateChat');
        };
        
        const getPrivateChatRoomId = (uid1, uid2) => uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        
        async function _sendPrivateChatMessage(payload) {
            if (!currentUserData || !currentPrivateChatPartner) return;
            const chatRoomId = getPrivateChatRoomId(currentUser.uid, currentPrivateChatPartner.uid);
            const recipientId = currentPrivateChatPartner.uid;
            const finalPayload = { senderId: currentUser.uid, senderName: currentUserData.displayName, timestamp: serverTimestamp(), ...payload };
            const updates = {}; const newMsgKey = push(ref(db, `private_chats/${chatRoomId}`)).key;
            updates[`private_chats/${chatRoomId}/${newMsgKey}`] = finalPayload;
            let inboxMessage = payload.type === 'image' ? '📷 Photo' : payload.type === 'audio' ? '🎤 Voice Message' : payload.text;
            updates[`user_inbox/${recipientId}/${chatRoomId}`] = { lastMessage: inboxMessage, senderName: currentUserData.displayName, timestamp: serverTimestamp(), unread: true };
            await update(ref(db), updates);
        }

        window.sendPrivateMessage = async () => {
            const button = UIElements.sendPrivateBtn; button.disabled = true;
            const input = document.getElementById('privateMessageInput'); let text = input.value.trim();
            if (text === '' || !currentUserData || !currentPrivateChatPartner) { button.disabled = false; return; }

            const recipientId = currentPrivateChatPartner.uid;
            const isBoySendingToGirl = currentUserData.userType === 'boy' && currentPrivateChatPartner.userType === 'girl';
            let canSend = true;

            if (isBoySendingToGirl) {
                if (currentUserData.coins < MESSAGE_COST) { button.disabled = false; return showNotification("You don't have enough coins.", 'error'); }
                try {
                    const senderTx = await runTransaction(ref(db, `users/${currentUser.uid}`), (user) => { if (user && user.coins >= MESSAGE_COST) { user.coins -= MESSAGE_COST; return user; } return; });
                    if (!senderTx.committed) throw new Error("Could not deduct coins.");
                    await runTransaction(ref(db, `users/${recipientId}`), (user) => {
                        if (user) { user.points = (user.points || 0) + GIRL_MSG_REWARD; user.earnedPoints = (user.earnedPoints || 0) + GIRL_MSG_REWARD; } return user;
                    });
                    await checkAndTriggerReferral(recipientId);
                    await runTransaction(ref(db, `owner_revenue`), (rev) => (rev || 0) + (MESSAGE_COST - GIRL_MSG_REWARD));
                } catch (e) { showNotification(`Message could not be sent: ${e.message}`, "error"); canSend = false; }
            }
            if(canSend) {
                await _sendPrivateChatMessage({ type: 'text', text: text });
                const soundElement = document.getElementById('sound-message-sent'); if (soundElement) { soundElement.currentTime = 0; soundElement.play().catch(e => {}); }
                input.value = '';
            }
            button.disabled = false;
        };
        
        window.handleImageUpload = async (event, context) => {
            const file = event.target.files[0]; if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showNotification('File too large (max 5MB).', 'error');
            const originalButtonText = '📷'; const button = (context === 'global') ? document.querySelector('#globalChat .chat-input button[title="Send Image"]') : document.querySelector('#privateChat .chat-input button[title="Send Image"]');
            if (button) { button.disabled = true; button.innerHTML = '...'; }
            showNotification('Uploading image...', 'info');
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData }); const data = await response.json();
                if (data.secure_url) {
                    const payload = { type: 'image', content: data.secure_url, senderId: currentUser.uid, senderName: currentUserData.displayName, timestamp: serverTimestamp() };
                    if (context === 'global') await push(ref(db, 'global_chat'), payload);
                    else if (context === 'private') await _sendPrivateChatMessage({ type: 'image', content: data.secure_url });
                    showNotification('Image sent!', 'success');
                } else { throw new Error(data.error.message); }
            } catch (error) { showNotification(`Image upload failed: ${error.message}`, 'error');
            } finally { if (button) { button.disabled = false; button.innerHTML = originalButtonText; } event.target.value = ''; }
        };

        window.toggleVoiceRecording = async (context) => {
            const voiceBtn = (context === 'global') ? document.getElementById('globalVoiceRecordBtn') : document.getElementById('privateVoiceRecordBtn'); if (!voiceBtn) return;
            if (isRecording) { mediaRecorder.stop(); voiceBtn.innerHTML = '🎤'; voiceBtn.style.background = ''; isRecording = false; } 
            else {
                if (context === 'private' && !currentPrivateChatPartner) return showNotification('Open a chat to record.', 'error');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); audioChunks = []; mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        showNotification('Uploading voice message...', 'info');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); const formData = new FormData();
                        formData.append('file', audioBlob, 'voice-message.webm'); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                        try {
                            const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData }); const data = await response.json();
                            if (data.secure_url) {
                                const payload = { type: 'audio', content: data.secure_url, senderId: currentUser.uid, senderName: currentUserData.displayName, timestamp: serverTimestamp() };
                                 if (context === 'global') await push(ref(db, 'global_chat'), payload);
                                else if (context === 'private') await _sendPrivateChatMessage({ type: 'audio', content: data.secure_url });
                                showNotification('Voice message sent!', 'success');
                            } else { throw new Error(data.error.message); }
                        } catch (error) { showNotification(`Upload failed: ${error.message}`, 'error'); }
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start(); voiceBtn.innerHTML = '🛑'; voiceBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)'; isRecording = true;
                    showNotification('Recording... Tap stop to send.', 'info');
                } catch (err) { showNotification('Could not access microphone.', 'error'); }
            }
        };

        window.handlePrivateEnter = (event) => { if (event.key === 'Enter') sendPrivateMessage(); };

        // --- Renders just the avatar picture and frame ---
        const createUserAvatarHTML = (user) => {
            const avatarPic = user.photoURL ? `<img src="${user.photoURL}" alt="Avatar">` : `<span>${(user.displayName || 'U').charAt(0).toUpperCase()}</span>`;
            let frameHTML = '';
            if (user.equippedFrame) {
                const frameData = FRAMES.find(f => f.id === user.equippedFrame);
                if (frameData) {
                    frameHTML = `<div class="avatar-frame" style="background-image: url('${frameData.imageUrl}');"></div>`;
                }
            } else if (calculateLevel(user.giftingSpend || 0).level >= 5) {
                 // Fallback to old VIP frame if no new frame is equipped but user is VIP
                 frameHTML = '<div class="profile-frame"></div>';
            }
            return `${avatarPic}${frameHTML}`;
        };
        
        const createUserCardHTML = (user) => {
            const isOnline = user.isOnline;
            const countryFlag = user.country ? `https://flagcdn.com/w20/${user.country.toLowerCase()}.png` : '';
            const wealthLevelData = calculateLevel(user.giftingSpend || 0);
            const charmLevelData = calculateLevel(user.charmPoints || 0);
            const isVip = wealthLevelData.level >= 5;
            const isSelf = currentUser && currentUser.uid === user.uid;
            
            const avatarContent = createUserAvatarHTML(user); // Use helper function
            const avatarClickAction = isSelf ? `onclick="document.getElementById('profilePicInput').click()"` : '';
            const avatarCursorStyle = isSelf ? 'cursor: pointer;' : 'cursor: default;';
            const avatarTitle = isSelf ? 'title="Click to change photo"' : '';
            
            const statusHTML = `<div class="user-status-text ${isOnline ? 'online' : 'offline'}"><span class="dot"></span> ${isOnline ? 'Online' : 'Offline'}</div>`;
            
            return `<div class="user-avatar" ${avatarClickAction} style="${avatarCursorStyle}" ${avatarTitle}>${avatarContent}</div><div class="user-info">${statusHTML}<div style="margin-bottom: 4px;"><span class="wealth-level-badge">💎LV.${wealthLevelData.level}</span><span class="charm-level-badge">❤️LV.${charmLevelData.level}</span>${isVip ? '<span class="vip-badge">VIP</span>' : ''}</div><h3>${user.displayName} <img src="${countryFlag}" alt="${user.country}" title="${user.country}" style="height: 16px; vertical-align: middle;"></h3><p style="opacity: 0.7; font-size: 0.9em;">@${user.username}</p></div>${!isSelf ? `<div class="user-actions"><button class="btn-small btn-message" onclick="startPrivateChat('${user.uid}')">💬 Message</button><button class="btn-small btn-gift" onclick="openGiftModal('${user.uid}')">🎁 Gift</button></div>` : '<p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">(This is you, click your avatar to change it)</p>'}`;
        };
        
        const updateUsersList = () => {
            const sortedUsers = Object.values(allUsersData).sort((a, b) => (b.isOnline || false) - (a.isOnline || false));
            UIElements.usersList.innerHTML = '';
            sortedUsers.forEach(user => {
                if (!user.uid || !user.username) return;
                const card = document.createElement('div'); card.className = 'user-card fade-in'; card.id = `user-card-${user.uid}`; card.innerHTML = createUserCardHTML(user);
                card.onclick = (e) => {
                    if (e.target.closest('.user-actions') || e.target.closest('.user-avatar[onclick]')) return;
                    if (currentUser.uid !== user.uid) startPrivateChat(user.uid);
                };
                UIElements.usersList.appendChild(card);
            });
            if(userInboxListener) { for (const chatRoomId in lastKnownInboxState) { if (lastKnownInboxState[chatRoomId].unread) { const partnerId = chatRoomId.replace(currentUser.uid, '').replace('_', ''); updateUserListNotificationIndicator(partnerId, true); } } }
        };
        
        window.filterUsers = () => {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            document.querySelectorAll('.user-card').forEach(card => {
                const user = allUsersData[card.id.replace('user-card-', '')];
                if (user) { const match = (user.displayName || '').toLowerCase().includes(searchTerm) || user.username.toLowerCase().includes(searchTerm); card.style.display = match ? 'block' : 'none'; }
            });
        };
        
        // --- EARN/SHOP/WALLET ---
        const checkDailyReward = () => {
            if (!currentUserData) return;
            const rewardAmount = currentUserData.userType === 'girl' ? 2000 : 500;
            UIElements.dailyRewardCoins.textContent = rewardAmount;
            const canClaim = (Date.now() - (currentUserData.lastDailyReward || 0)) > 24 * 60 * 60 * 1000;
            UIElements.dailyRewardBtn.disabled = !canClaim; UIElements.dailyRewardBtn.textContent = canClaim ? '🎁 Claim Now' : 'Come back tomorrow';
        };
        window.claimDailyReward = async () => {
            if (UIElements.dailyRewardBtn.disabled) return;
            const rewardAmount = currentUserData.userType === 'girl' ? 2000 : 500;
            try { await update(ref(db, `users/${currentUser.uid}`), { coins: (currentUserData.coins || 0) + rewardAmount, lastDailyReward: Date.now() }); showNotification(`You claimed ${rewardAmount} coins!`, 'success'); } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
        };
        window.watchAd = async () => {
            window.open('https://www.profitableratecpm.com/muuw280kve?key=e6c59b03cac111d09b4815509e3a3f08', '_blank');
            showNotification("Ad opened. Reward will be granted shortly...", 'info');
            setTimeout(async () => { await runTransaction(ref(db, `users/${currentUser.uid}/coins`), (c) => (c || 0) + 30); showNotification(`You earned 30 coins!`, 'success'); }, 5000);
        };
        window.shareReferral = () => { navigator.clipboard.writeText(currentUserData.referralCode).then(() => showNotification(`Referral code "${currentUserData.referralCode}" copied!`, 'success')); };
        
        const loadMyReferrals = () => {
            if (!currentUser) return;
            const myReferralsList = document.getElementById('myReferralsList');
            const referralsQuery = query(ref(db, 'users'), orderByChild('referredBy'), equalTo(currentUser.uid));

            onValue(referralsQuery, (snapshot) => {
                if (!snapshot.exists()) {
                    myReferralsList.innerHTML = '<p style="text-align:center; opacity: 0.7;">No one has joined using your code yet. Share it!</p>';
                    return;
                }

                let referralsHTML = '';
                snapshot.forEach(child => {
                    const referredUser = child.val();
                    const earned = referredUser.earnedPoints || 0;
                    const progress = Math.min((earned / REFERRAL_UNLOCK_POINTS) * 100, 100);
                    const isUnlocked = referredUser.referralUnlocked || false;

                    const avatarContent = createUserAvatarHTML(referredUser);
                    
                    referralsHTML += `
                        <div class="referral-list-item">
                            <div class="user-avatar" style="width: 50px; height: 50px; margin: 0; flex-shrink: 0;">${avatarContent}</div>
                            <div class="referral-info">
                                <div class="name">${referredUser.displayName}</div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${progress.toFixed(2)}%; background: linear-gradient(90deg, #6c5ce7, #a29bfe);"></div>
                                </div>
                                <div class="progress-bar-text">${earned.toLocaleString()} / ${REFERRAL_UNLOCK_POINTS.toLocaleString()} Points Earned</div>
                            </div>
                            <div class="referral-status ${isUnlocked ? 'unlocked' : 'pending'}">
                                ${isUnlocked ? '✅ Unlocked!' : 'Pending'}
                            </div>
                        </div>
                    `;
                });
                myReferralsList.innerHTML = referralsHTML;
            }, { onlyOnce: false }); // Use a persistent listener to get real-time progress
        };


        window.buyCoins = async (amount, price) => {
            const tid = prompt(`Send Rs. ${price} to Easypaisa/JazzCash 03222732251.\nEnter the Transaction ID (TID):`);
            if (tid && tid.trim()) {
                try { await push(ref(db, 'pending_purchases'), { userId: currentUser.uid, username: currentUserData.displayName, coinAmount: amount, price, transactionId: tid.trim(), status: 'pending', timestamp: serverTimestamp() }); showNotification('Request submitted. Coins will be added after verification.', 'info');
                } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
            } else { showNotification('Purchase cancelled.', 'error'); }
        };
        const loadWithdrawalHistory = () => {
            const q = query(ref(db, 'withdrawals'), orderByChild('userId'), equalTo(currentUser.uid));
            onValue(q, (snapshot) => { let html = ''; if (snapshot.exists()) { snapshot.forEach(child => { const data = child.val(); html += `<div class="admin-list-item" style="background: rgba(255,255,255,0.1);"><div><p><strong>Amount:</strong> ${data.amount.toLocaleString()} Points</p><p><strong>Method:</strong> ${data.method}</p><p><strong>Date:</strong> ${new Date(data.timestamp).toLocaleDateString()}</p></div><p><strong>Status:</strong> ${data.status}</p></div>`; }); UIElements.transactionHistory.innerHTML = html; } else { UIElements.transactionHistory.innerHTML = 'No withdrawal history found.'; } });
        };
        
        // --- GIFTING ---
        const populateGiftModal = () => { UIElements.giftsGrid.innerHTML = GIFTS.map(gift => `<div class="gift-item" data-gift-id="${gift.id}" onclick="selectGift(this, '${gift.price}')">${gift.isLucky ? '<span style="position:absolute; top:5px; right:5px; font-size:1.2rem; filter: drop-shadow(0 0 2px black);">🍀</span>' : ''}<div class="gift-icon">${gift.icon}</div><div>${gift.name}</div><div class="gift-price">${gift.price.toLocaleString()} 💰</div></div>`).join(''); };
        populateGiftModal();
        window.openGiftModal = (targetUserId) => {
            if (targetUserId) currentPrivateChatPartner = allUsersData[targetUserId];
            if (!currentPrivateChatPartner) return showNotification('Please select a user to gift.', 'error');
            giftTarget = { type: 'chat', id: currentPrivateChatPartner.uid, authorId: currentPrivateChatPartner.uid };
            UIElements.giftRecipient.textContent = currentPrivateChatPartner.displayName; UIElements.giftModal.classList.add('show');
        };
        window.openGiftModalForGlobalChatUser = (targetUserId) => {
            if (targetUserId === currentUser.uid) return showNotification("You can't send a gift to yourself.", 'info');
            const targetUserData = allUsersData[targetUserId]; if (!targetUserData) return showNotification("Could not find user to gift.", 'error');
            giftTarget = { type: 'global_chat', id: targetUserId, authorId: targetUserId };
            UIElements.giftRecipient.textContent = targetUserData.displayName; UIElements.giftModal.classList.add('show');
        };
        window.closeGiftModal = () => { UIElements.giftModal.classList.remove('show'); UIElements.sendGiftBtn.disabled = true; UIElements.sendGiftBtn.textContent = 'Select a gift to send'; UIElements.sendGiftBtn.dataset.giftId = ''; document.querySelectorAll('.gift-item.selected').forEach(el => el.classList.remove('selected')); giftTarget = { type: null, id: null, authorId: null }; };
        window.selectGift = (element, price) => { document.querySelectorAll('.gift-item.selected').forEach(el => el.classList.remove('selected')); element.classList.add('selected'); UIElements.sendGiftBtn.dataset.giftId = element.dataset.giftId; UIElements.sendGiftBtn.disabled = false; UIElements.sendGiftBtn.textContent = `🎁 Send Gift (${parseInt(price).toLocaleString()} 💰)`; };
        
        const handleLuckyGiftOutcome = async (senderId, giftPrice) => {
            const P = giftPrice; let prize = 0; let message = "Better luck next time!";
            const rand = Math.floor(Math.random() * 10000);
            if (rand < 1) { prize = P * 20; message = `🎉 JACKPOT! You won ${prize.toLocaleString()} coins back!`; }
            else if (rand < 11) { prize = P * 5; message = `🎉 SUPER WIN! You won ${prize.toLocaleString()} coins back!`; }
            else if (rand < 111) { prize = P * 2; message = `🎉 BIG WIN! You won ${prize.toLocaleString()} coins back!`; }
            else if (rand < 511) { prize = P * 1; message = `🍀 Lucky! You got your ${prize.toLocaleString()} coins back!`; }
            else if (rand < 2011) { prize = Math.floor(P * 0.5); message = `🍀 Nice! You won back ${prize.toLocaleString()} coins.`; }
            if (prize > 0) { try { await runTransaction(ref(db, `users/${senderId}/coins`), (coins) => (coins || 0) + prize); showNotification(message, 'success'); } catch (error) { console.error("Error awarding lucky prize:", error); } }
        };

        window.sendGift = async () => {
            const sendGiftButton = UIElements.sendGiftBtn; sendGiftButton.disabled = true; sendGiftButton.textContent = 'Sending...';
            const giftId = sendGiftButton.dataset.giftId;
            if (!giftId || !giftTarget.authorId) { showNotification('Error: Target not defined.', 'error'); sendGiftButton.disabled = false; sendGiftButton.textContent = 'Select a gift to send'; return; }
            const gift = GIFTS.find(g => g.id === giftId); if (!gift) return showNotification('Invalid gift selected.', 'error');
            const receiverId = giftTarget.authorId; let senderCharged = false;
            try {
                const senderTx = await runTransaction(ref(db, `users/${currentUser.uid}`), (user) => { if (user && (user.coins || 0) >= gift.price) { user.coins -= gift.price; user.giftingSpend = (user.giftingSpend || 0) + gift.price; return user; } return; });
                if (!senderTx.committed) throw new Error("You don't have enough coins.");
                senderCharged = true;
                const receiverShare = Math.floor(gift.price * (1 - OWNER_REVENUE_SHARE)); const ownerShare = gift.price - receiverShare;
                await runTransaction(ref(db, `users/${receiverId}`), (user) => {
                    if (user) { user.charmPoints = (user.charmPoints || 0) + gift.price; user.points = (user.points || 0) + receiverShare; user.earnedPoints = (user.earnedPoints || 0) + receiverShare; } return user;
                });
                await checkAndTriggerReferral(receiverId);
                await runTransaction(ref(db, 'owner_revenue'), (revenue) => (revenue || 0) + ownerShare);
                const otherUpdates = {};
                otherUpdates[`gift_logs/${push(ref(db, 'gift_logs')).key}`] = { senderId: currentUser.uid, receiverId, giftId: gift.id, price: gift.price, context: giftTarget.type, contextId: giftTarget.id, timestamp: serverTimestamp() };
                const receiverData = allUsersData[receiverId]; if (!receiverData) throw new Error("Receiver data not found.");
                
                let giftMessageText = `🎁 <strong>${currentUserData.displayName}</strong> sent a ${gift.icon} ${gift.name} to <strong>${receiverData.displayName}</strong>!`;

                if (giftTarget.type === 'global_chat') {
                    otherUpdates[`global_chat/${push(ref(db, 'global_chat')).key}`] = { type: 'system', text: giftMessageText, timestamp: serverTimestamp() };
                } else if (giftTarget.type === 'chat') {
                    const chatRoomId = getPrivateChatRoomId(currentUser.uid, receiverId);
                    const privateGiftMessageText = `🎁 <strong>${currentUserData.displayName} sent you a ${gift.icon} ${gift.name}!</strong> (+${receiverShare.toLocaleString()} points)`;
                    otherUpdates[`private_chats/${chatRoomId}/${push(ref(db, `private_chats/${chatRoomId}`)).key}`] = { type: 'system', text: privateGiftMessageText, timestamp: serverTimestamp() };
                    otherUpdates[`user_inbox/${receiverId}/${chatRoomId}`] = { lastMessage: `${gift.icon} New Gift!`, senderName: currentUserData.displayName, timestamp: serverTimestamp(), unread: true };
                } else if (giftTarget.type === 'post' || giftTarget.type === 'video') {
                    const dbPath = giftTarget.type === 'post' ? 'posts' : 'videos';
                    await runTransaction(ref(db, `${dbPath}/${giftTarget.id}/giftRevenue`), (rev) => (rev || 0) + gift.price);
                    const postCommentText = `🎁 ${currentUserData.displayName} sent a ${gift.icon} ${gift.name}!`;
                    otherUpdates[`${dbPath}/${giftTarget.id}/comments/${push(ref(db, `${dbPath}/${giftTarget.id}/comments`)).key}`] = { authorId: 'system', authorName: 'Gift Bot', text: postCommentText, timestamp: serverTimestamp() };
                } else if (giftTarget.type === 'voice_room') {
                    otherUpdates[`voice_rooms/${giftTarget.id}/chat/${push(ref(db, `voice_rooms/${giftTarget.id}/chat`)).key}`] = { type: 'system', text: giftMessageText, timestamp: serverTimestamp() };
                }

                await update(ref(db), otherUpdates);
                showNotification(`You sent a ${gift.name} to ${receiverData.displayName}!`, 'success');
                const soundElement = document.getElementById(`sound-${gift.id.replace(/\s/g, '')}`);
                if (soundElement) { soundElement.currentTime = 0; soundElement.play().catch(e=>{}); }
                if (gift.isLucky) await handleLuckyGiftOutcome(currentUser.uid, gift.price);
                closeGiftModal();
            } catch (error) {
                console.error("Gift sending failed:", error);
                let errorMessage = `Failed to send gift: ${error.message}.`;
                if (senderCharged) { errorMessage += ' Refunding your coins.'; await runTransaction(ref(db, `users/${currentUser.uid}/coins`), (coins) => (coins || 0) + gift.price); }
                showNotification(errorMessage, "error");
            } finally { if (UIElements.giftModal.classList.contains('show')) { sendGiftButton.disabled = false; sendGiftButton.textContent = `🎁 Send Gift (${parseInt(gift?.price || 0).toLocaleString()} 💰)`; } }
        };

        // --- SHOP & FRAMES ---
        const populateShop = () => {
            if (!currentUserData) return;
            const staticGrid = document.getElementById('static-frames-grid');
            const animatedGrid = document.getElementById('animated-frames-grid');
            staticGrid.innerHTML = '';
            animatedGrid.innerHTML = '';
            
            const ownedFrames = currentUserData.ownedFrames || {};

            FRAMES.forEach(frame => {
                const isOwned = ownedFrames[frame.id];
                const buttonHTML = isOwned
                    ? `<button class="btn btn-success" disabled>✔️ Owned</button>`
                    : `<button class="btn" onclick="buyFrame('${frame.id}')">Buy</button>`;

                const frameHTML = `
                    <div class="frame-item">
                        <img src="${frame.imageUrl}" alt="${frame.name}" class="frame-preview">
                        <div class="frame-name">${frame.name}</div>
                        <div class="frame-price">💰 ${frame.price.toLocaleString()}</div>
                        ${buttonHTML}
                    </div>`;
                
                if (frame.type === 'static') {
                    staticGrid.innerHTML += frameHTML;
                } else {
                    animatedGrid.innerHTML += frameHTML;
                }
            });
        };

        window.buyFrame = async (frameId) => {
            const frame = FRAMES.find(f => f.id === frameId);
            if (!frame) return showNotification('Frame not found.', 'error');
            if ((currentUserData.ownedFrames || {})[frameId]) return showNotification('You already own this frame.', 'info');
            if ((currentUserData.coins || 0) < frame.price) return showNotification("You don't have enough coins to buy this frame.", 'error');

            const updates = {};
            updates[`users/${currentUser.uid}/coins`] = (currentUserData.coins || 0) - frame.price;
            updates[`users/${currentUser.uid}/ownedFrames/${frameId}`] = true;

            try {
                await update(ref(db), updates);
                showNotification(`Successfully purchased the "${frame.name}" frame! You can equip it from your profile.`, 'success');
            } catch (error) {
                showNotification(`Purchase failed: ${error.message}`, 'error');
            }
        };

        const updateProfileFramesUI = () => {
            if (!currentUserData) return;
            const myFramesGrid = document.getElementById('myFramesGrid');
            const ownedFrames = currentUserData.ownedFrames || {};
            const equippedFrame = currentUserData.equippedFrame;

            if (Object.keys(ownedFrames).length === 0) {
                myFramesGrid.innerHTML = `<p style="opacity:0.7; grid-column: 1 / -1; text-align: center;">You don't own any frames yet. Visit the shop!</p>`;
                return;
            }

            let framesHTML = '';
            if (equippedFrame) {
                 framesHTML += `<div class="my-frame-item"><button class="btn btn-danger btn-small" onclick="unequipFrame()">Unequip Current</button></div>`;
            }

            Object.keys(ownedFrames).forEach(frameId => {
                const frameData = FRAMES.find(f => f.id === frameId);
                if (frameData) {
                    const isEquipped = equippedFrame === frameId;
                    framesHTML += `
                        <div class="my-frame-item">
                            <img src="${frameData.imageUrl}" alt="${frameData.name}">
                            <button class="btn btn-small" onclick="equipFrame('${frameId}')" ${isEquipped ? 'disabled' : ''}>
                                ${isEquipped ? '✅ Equipped' : 'Equip'}
                            </button>
                        </div>`;
                }
            });
            myFramesGrid.innerHTML = framesHTML;
        };

        window.equipFrame = async (frameId) => {
            try {
                await update(ref(db, `users/${currentUser.uid}`), { equippedFrame: frameId });
                showNotification('Frame equipped!', 'success');
            } catch(error) {
                showNotification(`Failed to equip frame: ${error.message}`, 'error');
            }
        };

        window.unequipFrame = async () => {
            try {
                await update(ref(db, `users/${currentUser.uid}`), { equippedFrame: null });
                showNotification('Frame unequipped.', 'info');
            } catch(error) {
                showNotification(`Failed to unequip frame: ${error.message}`, 'error');
            }
        };

        // --- POSTS / MOMENTS FEATURE ---
        window.openCreatePostModal = () => UIElements.createPostModal.classList.add('show');
        window.closeCreatePostModal = () => UIElements.createPostModal.classList.remove('show');
        window.createPost = async () => {
            const postBtn = document.getElementById('createPostBtn'); postBtn.disabled = true; postBtn.textContent = 'Uploading...';
            const text = document.getElementById('postText').value.trim(); const file = document.getElementById('postImageInput').files[0];
            if (!text && !file) { showNotification('Please write something or select an image.', 'error'); postBtn.disabled = false; postBtn.textContent = '🚀 Share Post'; return; }
            let imageUrl = null;
            if (file) {
                if (file.size > 5 * 1024 * 1024) { showNotification('Image is too large (max 5MB).', 'error'); postBtn.disabled = false; postBtn.textContent = '🚀 Share Post'; return; }
                showNotification('Uploading image for post...', 'info'); const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                try {
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData }); const data = await response.json();
                    if (data.secure_url) imageUrl = data.secure_url; else throw new Error(data.error?.message || 'Cloudinary upload failed');
                } catch (error) { showNotification(`Image upload failed: ${error.message}`, 'error'); postBtn.disabled = false; postBtn.textContent = '🚀 Share Post'; return; }
            }
            const postData = { authorId: currentUser.uid, authorName: currentUserData.displayName, authorPhotoURL: currentUserData.photoURL || null, text: text, imageUrl: imageUrl, timestamp: serverTimestamp(), likes: 0, giftRevenue: 0 };
            try {
                await push(ref(db, 'posts'), postData);
                showNotification('Post shared successfully!', 'success'); closeCreatePostModal(); document.getElementById('postText').value = ''; document.getElementById('postImageInput').value = '';
            } catch (error) { showNotification(`Failed to share post: ${error.message}`, 'error'); } finally { postBtn.disabled = false; postBtn.textContent = '🚀 Share Post'; }
        };

        const loadPostsFeed = () => {
            if (postsListener) postsListener();
            const postsRef = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(50));
            postsListener = onValue(postsRef, (snapshot) => {
                if (!snapshot.exists()) {
                    UIElements.postsFeed.innerHTML = '<p style="text-align:center;">No moments yet. Be the first to share one!</p>';
                    return;
                }
                let postsHTML = '';
                const posts = [];
                snapshot.forEach(child => {
                    posts.push({ id: child.key, ...child.val() });
                });
                
                posts.reverse().forEach(post => {
                    postsHTML += createPostHTML(post);
                });

                UIElements.postsFeed.innerHTML = postsHTML;
            });
        };

        const createPostHTML = (post) => {
            const postTime = new Date(post.timestamp).toLocaleString(); const isLiked = post.likedBy && post.likedBy[currentUser.uid];
            const authorData = allUsersData[post.authorId] || { photoURL: post.authorPhotoURL, displayName: post.authorName, equippedFrame: null }; // Fallback
            const avatarContent = createUserAvatarHTML(authorData);
            let commentsHTML = ''; if (post.comments) { Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp).forEach(comment => { commentsHTML += `<div class="comment"><p><strong>${comment.authorName}:</strong> ${comment.text}</p></div>`; }); }
            return `<div class="post-card fade-in" id="post-${post.id}"><div class="post-header"><div class="user-avatar">${avatarContent}</div><div class="post-header-info"><h4>${post.authorName}</h4><p>${postTime}</p></div></div><div class="post-body">${post.text ? `<p class="post-text">${post.text}</p>` : ''}${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post image" onclick="window.open('${post.imageUrl}', '_blank')">` : ''}</div><div class="post-stats"><span>❤️ ${post.likes || 0} Likes</span> &nbsp;&nbsp;<span>💬 ${post.comments ? Object.keys(post.comments).length : 0} Comments</span></div><div class="post-actions"><button class="action-btn ${isLiked ? 'active' : ''}" onclick="toggleLikePost('${post.id}')">❤️ Like</button><button class="action-btn" onclick="document.getElementById('comment-input-${post.id}').focus()">💬 Comment</button><button class="action-btn" onclick="sharePost('${post.id}')">🔗 Share</button>${post.authorId !== currentUser.uid ? `<button class="action-btn" onclick="openGiftModalForPost('${post.id}', '${post.authorId}')">🎁 Gift</button>` : ''}</div><div class="post-comments">${commentsHTML}<div class="comment-input-area"><input type="text" id="comment-input-${post.id}" class="form-group" placeholder="Add a comment..." onkeypress="handleCommentEnter(event, '${post.id}')" style="margin-bottom:0;"><button class="send-btn" style="border-radius:20px; min-width: auto; padding: 0 20px; margin:0;" onclick="addComment('${post.id}')">Send</button></div></div></div>`;
        };
        window.toggleLikePost = (postId) => {
            const postLikesRef = ref(db, `posts/${postId}/likedBy/${currentUser.uid}`);
            get(postLikesRef).then(snapshot => {
                const postStatsRef = ref(db, `posts/${postId}/likes`);
                if (snapshot.exists()) { remove(postLikesRef); runTransaction(postStatsRef, (likes) => (likes || 1) - 1); } 
                else { set(postLikesRef, true); runTransaction(postStatsRef, (likes) => (likes || 0) + 1); }
            });
        };
        window.addComment = (postId) => {
            const input = document.getElementById(`comment-input-${postId}`); const text = input.value.trim(); if (!text) return;
            push(ref(db, `posts/${postId}/comments`), { authorId: currentUser.uid, authorName: currentUserData.displayName, text: text, timestamp: serverTimestamp() });
            input.value = '';
        };
        window.handleCommentEnter = (event, postId) => { if (event.key === 'Enter') addComment(postId); };
        window.sharePost = (postId) => { const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`; navigator.clipboard.writeText(`Check out this post on Global Chat: ${postUrl}`).then(() => showNotification('Post link copied!', 'success')).catch(err => showNotification('Could not copy link.', 'error')); };
        window.openGiftModalForPost = (postId, authorId) => {
            const authorData = allUsersData[authorId]; if (!authorData) return showNotification('Post author not found.', 'error');
            giftTarget = { type: 'post', id: postId, authorId: authorId };
            UIElements.giftRecipient.textContent = authorData.displayName; UIElements.giftModal.classList.add('show');
        };

        // --- VIDEOS FEATURE ---
        window.openCreateVideoModal = () => UIElements.createVideoModal.classList.add('show');
        window.closeCreateVideoModal = () => UIElements.createVideoModal.classList.remove('show');
        window.createVideo = async () => {
            const videoBtn = document.getElementById('createVideoBtn'); videoBtn.disabled = true; videoBtn.textContent = 'Uploading...';
            const caption = document.getElementById('videoCaption').value.trim(); const file = document.getElementById('videoFileInput').files[0];
            if (!file) { showNotification('Please select a video file.', 'error'); videoBtn.disabled = false; videoBtn.textContent = '🎬 Upload Video'; return; }
            if (file.size > 100 * 1024 * 1024) { showNotification('Video is too large (max 100MB).', 'error'); videoBtn.disabled = false; videoBtn.textContent = '🎬 Upload Video'; return; }
            showNotification('Uploading video... This may take a moment.', 'info');
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); formData.append('resource_type', 'video');
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData }); const data = await response.json();
                if (data.secure_url) {
                    await push(ref(db, 'videos'), { authorId: currentUser.uid, authorName: currentUserData.displayName, authorPhotoURL: currentUserData.photoURL || null, caption: caption, videoUrl: data.secure_url, timestamp: serverTimestamp(), likes: 0, giftRevenue: 0 });
                    showNotification('Video uploaded successfully!', 'success'); closeCreateVideoModal(); document.getElementById('videoCaption').value = ''; document.getElementById('videoFileInput').value = '';
                } else throw new Error(data.error?.message || 'Cloudinary upload failed');
            } catch (error) { showNotification(`Video upload failed: ${error.message}`, 'error'); } finally { videoBtn.disabled = false; videoBtn.textContent = '🎬 Upload Video'; }
        };

        const loadVideosFeed = () => {
            if (videosListener) videosListener();
            const videosRef = query(ref(db, 'videos'), orderByChild('timestamp'), limitToLast(50));
            videosListener = onValue(videosRef, (snapshot) => {
                if (!snapshot.exists()) {
                    UIElements.videosFeed.innerHTML = '<p style="text-align:center;">No videos yet. Be the first to upload one!</p>';
                    return;
                }
                let videosHTML = '';
                const videos = [];
                snapshot.forEach(child => {
                    videos.push({ id: child.key, ...child.val() });
                });
                
                videos.reverse().forEach(video => {
                    videosHTML += createVideoHTML(video);
                });
                
                UIElements.videosFeed.innerHTML = videosHTML;
            });
        };

        const createVideoHTML = (video) => {
            const videoTime = new Date(video.timestamp).toLocaleString(); const isLiked = video.likedBy && video.likedBy[currentUser.uid];
            const authorData = allUsersData[video.authorId] || { photoURL: video.authorPhotoURL, displayName: video.authorName, equippedFrame: null }; // Fallback
            const avatarContent = createUserAvatarHTML(authorData);
            let commentsHTML = ''; if (video.comments) { Object.values(video.comments).sort((a, b) => a.timestamp - b.timestamp).forEach(comment => { commentsHTML += `<div class="comment"><p><strong>${comment.authorName}:</strong> ${comment.text}</p></div>`; }); }
            return `<div class="post-card fade-in" id="video-${video.id}"><div class="post-header"><div class="user-avatar">${avatarContent}</div><div class="post-header-info"><h4>${video.authorName}</h4><p>${videoTime}</p></div></div><div class="post-body">${video.caption ? `<p class="post-text">${video.caption}</p>` : ''}<video src="${video.videoUrl}" class="post-video" controls playsinline loop muted></video></div><div class="post-stats"><span>❤️ ${video.likes || 0} Likes</span> &nbsp;&nbsp;<span>💬 ${video.comments ? Object.keys(video.comments).length : 0} Comments</span></div><div class="post-actions"><button class="action-btn ${isLiked ? 'active' : ''}" onclick="toggleLikeVideo('${video.id}')">❤️ Like</button><button class="action-btn" onclick="document.getElementById('video-comment-input-${video.id}').focus()">💬 Comment</button><button class="action-btn" onclick="shareVideo('${video.id}')">🔗 Share</button>${video.authorId !== currentUser.uid ? `<button class="action-btn" onclick="openGiftModalForVideo('${video.id}', '${video.authorId}')">🎁 Gift</button>` : ''}</div><div class="post-comments">${commentsHTML}<div class="comment-input-area"><input type="text" id="video-comment-input-${video.id}" class="form-group" placeholder="Add a comment..." onkeypress="handleVideoCommentEnter(event, '${video.id}')" style="margin-bottom:0;"><button class="send-btn" style="border-radius:20px; min-width: auto; padding: 0 20px; margin:0;" onclick="addVideoComment('${video.id}')">Send</button></div></div></div>`;
        };
        window.toggleLikeVideo = (videoId) => {
            const videoLikesRef = ref(db, `videos/${videoId}/likedBy/${currentUser.uid}`);
            get(videoLikesRef).then(snapshot => {
                const videoStatsRef = ref(db, `videos/${videoId}/likes`);
                if (snapshot.exists()) { remove(videoLikesRef); runTransaction(videoStatsRef, (likes) => (likes || 1) - 1); } 
                else { set(videoLikesRef, true); runTransaction(videoStatsRef, (likes) => (likes || 0) + 1); }
            });
        };
        window.addVideoComment = (videoId) => {
            const input = document.getElementById(`video-comment-input-${videoId}`); const text = input.value.trim(); if (!text) return;
            push(ref(db, `videos/${videoId}/comments`), { authorId: currentUser.uid, authorName: currentUserData.displayName, text: text, timestamp: serverTimestamp() });
            input.value = '';
        };
        window.handleVideoCommentEnter = (event, videoId) => { if (event.key === 'Enter') addVideoComment(videoId); };
        window.shareVideo = (videoId) => { const videoUrl = `${window.location.origin}${window.location.pathname}#video-${videoId}`; navigator.clipboard.writeText(`Check out this video on Global Chat: ${videoUrl}`).then(() => showNotification('Video link copied!', 'success')).catch(err => showNotification('Could not copy link.', 'error')); };
        window.openGiftModalForVideo = (videoId, authorId) => {
            const authorData = allUsersData[authorId]; if (!authorData) return showNotification('Video creator not found.', 'error');
            giftTarget = { type: 'video', id: videoId, authorId: authorId };
            UIElements.giftRecipient.textContent = authorData.displayName; UIElements.giftModal.classList.add('show');
        };

        // --- VOICE ROOM FEATURE ---
        window.openCreateVoiceRoomModal = () => UIElements.createVoiceRoomModal.classList.add('show');
        window.closeCreateVoiceRoomModal = () => UIElements.createVoiceRoomModal.classList.remove('show');

        window.createVoiceRoom = async () => {
            const roomName = document.getElementById('newRoomName').value.trim();
            const seatCount = parseInt(document.getElementById('newRoomSeats').value);
            if (!roomName) return showNotification('Please enter a room name.', 'error');

            const createBtn = document.getElementById('createVoiceRoomBtn');
            createBtn.disabled = true; createBtn.textContent = 'Creating...';

            const newRoomRef = push(ref(db, 'voice_rooms'));
            const roomData = {
                id: newRoomRef.key,
                name: roomName,
                hostId: currentUser.uid,
                hostName: currentUserData.displayName,
                seatCount: seatCount,
                createdAt: serverTimestamp(),
                members: {
                    [currentUser.uid]: {
                        displayName: currentUserData.displayName,
                        photoURL: currentUserData.photoURL || null, 
                        isMuted: true
                    }
                }
            };
            
            try {
                await set(newRoomRef, roomData);
                closeCreateVoiceRoomModal();
                showNotification('Room created successfully!', 'success');
                joinVoiceRoom(newRoomRef.key);
            } catch (error) {
                console.error("Error creating room:", error);
                showNotification(`Failed to create room: ${error.message}`, 'error');
            } finally {
                createBtn.disabled = false; createBtn.textContent = '🚀 Create Room';
            }
        };
        
        const loadVoiceRooms = () => {
            if (voiceRoomsListener) voiceRoomsListener();
            const voiceRoomsListEl = document.getElementById('voiceRoomsList');
            const roomsQuery = query(ref(db, 'voice_rooms'), orderByChild('createdAt'), limitToLast(50));
            
            voiceRoomsListener = onValue(roomsQuery, (snapshot) => {
                if (!snapshot.exists()) {
                    voiceRoomsListEl.innerHTML = '<p style="text-align:center; opacity:0.8;">No active voice rooms. Why not create one?</p>';
                    return;
                }
                
                let roomsHTML = '';
                snapshot.forEach(child => {
                    const room = { id: child.key, ...child.val() };
                    const memberCount = room.members ? Object.keys(room.members).length : 0;
                    const singleRoomHTML = `
                        <div class="voice-room-card">
                            <div class="voice-room-info">
                                <h4>${room.name}</h4>
                                <p>Host: ${room.hostName} | ${memberCount}/${room.seatCount} people</p>
                            </div>
                            <button class="btn btn-success" style="width:auto; margin:0;" onclick="joinVoiceRoom('${room.id}')">Join Room</button>
                        </div>
                    `;
                    roomsHTML = singleRoomHTML + roomsHTML;
                });

                voiceRoomsListEl.innerHTML = roomsHTML;
            });
        };

        // --- START OF WEBRTC IMPLEMENTATION ---

        window.joinVoiceRoom = async (roomId) => {
            if (!currentUser || !currentUserData) return;
            
            try {
                // 1. Microphone ki permission lein
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (error) {
                showNotification('Microphone access denied. Please allow microphone access.', 'error');
                console.error("getUserMedia error:", error);
                return;
            }

            const roomRef = ref(db, `voice_rooms/${roomId}`);
            const roomSnapshot = await get(roomRef);
            if (!roomSnapshot.exists()) return showNotification('This room no longer exists.', 'error');
            
            const roomData = roomSnapshot.val();
            const memberCount = roomData.members ? Object.keys(roomData.members).length : 0;
            const isAlreadyMember = roomData.members && roomData.members[currentUser.uid];

            if (memberCount >= roomData.seatCount && !isAlreadyMember) {
                localStream.getTracks().forEach(track => track.stop()); // Stop mic if room is full
                return showNotification('This room is full.', 'error');
            }

            currentVoiceRoomId = roomId;
            const memberPath = `voice_rooms/${roomId}/members/${currentUser.uid}`;
            await update(ref(db), {
                [memberPath]: {
                    displayName: currentUserData.displayName,
                    photoURL: currentUserData.photoURL || null,
                    isMuted: true // Start muted
                }
            });
            onDisconnect(ref(db, memberPath)).remove();

            showVoiceRoomView(roomId);
        };
        
        const showVoiceRoomView = (roomId) => {
            document.getElementById('voiceRoomView').classList.add('show');
            if (currentVoiceRoomListener) currentVoiceRoomListener();
            
            const roomRef = ref(db, `voice_rooms/${roomId}`);
            currentVoiceRoomListener = onValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    leaveVoiceRoom(true); 
                    return;
                }
                const roomData = snapshot.val();
                renderVoiceRoomUI(roomData);

                // WebRTC Connections ko manage karein
                const members = roomData.members || {};
                const memberIds = Object.keys(members);

                // Naye members ke liye connections banayein
                memberIds.forEach(memberId => {
                    if (memberId !== currentUser.uid && !peerConnections[memberId]) {
                        peerConnections[memberId] = createPeerConnection(memberId, roomId);
                    }
                });
                
                // Jo members chale gaye unke connections band karein
                Object.keys(peerConnections).forEach(peerId => {
                    if (!memberIds.includes(peerId)) {
                        if (peerConnections[peerId]) {
                            peerConnections[peerId].close();
                        }
                        delete peerConnections[peerId];

                        // Listener bhi remove karein
                        if(signalingListeners[peerId]) {
                            signalingListeners[peerId].unsubscribeOffer();
                            signalingListeners[peerId].unsubscribeICE();
                            delete signalingListeners[peerId];
                        }
                        
                        const audioEl = document.getElementById(`audio-${peerId}`);
                        if (audioEl) audioEl.remove();
                    }
                });
            });
        };

        function createPeerConnection(targetUserId, roomId) {
            const pc = new RTCPeerConnection(iceServers);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    // ICE candidate doosre user ko Firebase ke zariye bhejein
                    const signalRef = ref(db, `voice_rooms/${roomId}/signaling/${targetUserId}/${currentUser.uid}/iceCandidates`);
                    push(signalRef, event.candidate.toJSON());
                }
            };
            
            pc.ontrack = event => {
                // Jab doosre user ki audio stream aaye
                const audioContainer = document.getElementById('audio-elements-container');
                let audioEl = document.getElementById(`audio-${targetUserId}`);
                if (!audioEl) {
                    audioEl = document.createElement('audio');
                    audioEl.id = `audio-${targetUserId}`;
                    audioEl.autoplay = true;
                    audioContainer.appendChild(audioEl);
                }
                audioEl.srcObject = event.streams[0];
            };

            // Apni audio stream ko connection mein add karein
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }
            
            // Signaling ke liye listeners setup karein
            setupSignalingListeners(targetUserId, roomId, pc);
            
            return pc;
        }
        
        // --- UPDATED FUNCTION ---
        function setupSignalingListeners(targetUserId, roomId, pc) {
            const myId = currentUser.uid;
            const offerRef = ref(db, `voice_rooms/${roomId}/signaling/${myId}/${targetUserId}`);
            const iceRef = ref(db, `voice_rooms/${roomId}/signaling/${myId}/${targetUserId}/iceCandidates`);

            // Jab koi offer ya answer aaye
            const unsubscribeOffer = onValue(offerRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.offer) {
                        try {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            set(ref(db, `voice_rooms/${roomId}/signaling/${targetUserId}/${myId}/answer`), answer.toJSON());
                        } catch (e) {
                            console.error("Error setting remote/local description:", e);
                        }
                    } else if (data.answer) {
                         try {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                         } catch (e) {
                            console.error("Error setting remote description from answer:", e);
                         }
                    }
                }
            });

            // Jab koi ICE candidate aaye
            const unsubscribeICE = onValue(iceRef, (snapshot) => {
                snapshot.forEach(child => {
                    try {
                        const candidate = new RTCIceCandidate(child.val());
                        pc.addIceCandidate(candidate);
                    } catch (e) {
                        console.error("Error adding ICE candidate:", e);
                    }
                });
            });

            // Unsubscribe functions ko store karein taake baad mein detach kar sakein
            signalingListeners[targetUserId] = { unsubscribeOffer, unsubscribeICE };
        }


        async function startCall(targetUserId, roomId) {
            const pc = peerConnections[targetUserId];
            if(!pc) return;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            set(ref(db, `voice_rooms/${roomId}/signaling/${targetUserId}/${currentUser.uid}/offer`), offer.toJSON());
        }

        const renderVoiceRoomUI = (roomData) => {
            if (!roomData) return;
            document.getElementById('voiceRoomName').textContent = roomData.name;
            document.getElementById('voiceRoomHost').textContent = `Hosted by: ${roomData.hostName}`;
            
            const seatsGrid = document.getElementById('voiceRoomSeatsGrid');
            seatsGrid.innerHTML = '';
            seatsGrid.className = `voice-room-seats-grid seats-${roomData.seatCount}`;
            
            const members = roomData.members || {};
            const memberIds = Object.keys(members);
            
            memberIds.forEach(memberId => {
                // Jab koi naya user join kare, usko call karein
                if (memberId !== currentUser.uid && peerConnections[memberId] && (peerConnections[memberId].connectionState === 'new' || peerConnections[memberId].connectionState === 'disconnected')) {
                    startCall(memberId, currentVoiceRoomId);
                }
            });

            for (let i = 0; i < roomData.seatCount; i++) {
                const seat = document.createElement('div');
                const memberId = memberIds[i];
                if (memberId) {
                    const memberData = members[memberId];
                    const userData = allUsersData[memberId];
                    const isHost = memberId === roomData.hostId;
                    const isSelf = memberId === currentUser.uid;

                    seat.className = 'voice-room-seat';
                    seat.id = `seat-${memberId}`;
                    seat.onclick = () => { if (!isSelf) openGiftModalForVoiceRoomUser(memberId, roomData.id); };

                    const avatar = userData ? createUserAvatarHTML(userData) : `<img src="${memberData.photoURL}" alt="Avatar">`;
                    
                    seat.innerHTML = `
                        <div class="user-avatar" style="width:80px; height:80px;">${avatar}</div>
                        <div class="seat-name">${memberData.displayName}</div>
                        <div class="seat-status">${isHost ? '👑 Host' : (isSelf ? '(You)' : '')}</div>
                    `;
                    if (memberData.isMuted && isSelf) {
                        const muteIcon = document.createElement('span');
                        muteIcon.innerHTML = '🔇';
                        muteIcon.style.position = 'absolute'; muteIcon.style.bottom = '10px'; muteIcon.style.right = '10px';
                        seat.appendChild(muteIcon);
                    }
                } else {
                    seat.className = 'voice-room-seat empty';
                    seat.innerHTML = `<div class="user-avatar" style="width:80px; height:80px;"><span></span></div><div class="seat-name">Empty Seat</div>`;
                }
                seatsGrid.appendChild(seat);
            }

            const chatMessagesEl = document.getElementById('voiceRoomChatMessages');
            let chatHTML = '';
            if (roomData.chat) {
                Object.values(roomData.chat).sort((a,b) => a.timestamp - b.timestamp).forEach(msg => {
                    chatHTML += createMessageHTML(msg, currentUser.uid);
                });
            }
            chatMessagesEl.innerHTML = chatHTML;
            scrollToBottom(chatMessagesEl);
        };
        
        // --- UPDATED FUNCTION ---
        window.leaveVoiceRoom = async (isForced = false) => {
            if (!currentVoiceRoomId) return;

            const roomId = currentVoiceRoomId;
            const myUid = currentUser.uid;
            const memberRef = ref(db, `voice_rooms/${roomId}/members/${myUid}`);
            
            // Saare peer connections band karein
            Object.keys(peerConnections).forEach(key => {
                if(peerConnections[key]) {
                    peerConnections[key].close();
                }
            });
            peerConnections = {};

            // Saare signaling listeners ko detach karein
            Object.keys(signalingListeners).forEach(peerId => {
                const listeners = signalingListeners[peerId];
                if (listeners) {
                    listeners.unsubscribeOffer();
                    listeners.unsubscribeICE();
                }
            });
            signalingListeners = {};
            
            // Local microphone stream ko band karein
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Main room data ke listener ko detach karein
            if (currentVoiceRoomListener) {
                currentVoiceRoomListener(); // This is the unsubscribe function from onValue
                currentVoiceRoomListener = null;
            }

            // 'onDisconnect' handler cancel karein
            onDisconnect(memberRef).cancel();

            const roomRef = ref(db, `voice_rooms/${roomId}`);
            const roomSnapshot = await get(roomRef);

            // Agar room मौजूद hai, to host check karein ya member remove karein
            if (roomSnapshot.exists()) {
                const roomData = roomSnapshot.val();
                // Agar user host hai, to poora room delete kar dein
                if (roomData.hostId === myUid) {
                    await remove(roomRef); 
                    if (!isForced) showNotification('You closed the room.', 'info');
                } else {
                    // Warna sirf khud ko members list se remove karein
                    await remove(memberRef);
                }
            }

            // UI ko saaf karein
            document.getElementById('voiceRoomView').classList.remove('show');
            document.getElementById('audio-elements-container').innerHTML = '';
            currentVoiceRoomId = null;

            if (!isForced) {
                showTab('voiceRooms');
            } else {
                showTab('globalChat'); // forced leave hone par global chat par bhej dein
                showNotification("The host has closed the room.", "info");
            }
        };

        window.toggleVoiceRoomMute = () => {
            if (!currentVoiceRoomId || !localStream) return;
            const muteBtn = document.getElementById('voiceRoomMuteBtn');
            const audioTrack = localStream.getAudioTracks()[0];
            if (!audioTrack) return;

            const newMutedState = !audioTrack.enabled;
            audioTrack.enabled = !newMutedState;

            muteBtn.innerHTML = newMutedState ? '🎙️ Unmute' : '🔇 Mute';
            const memberMuteRef = ref(db, `voice_rooms/${currentVoiceRoomId}/members/${currentUser.uid}/isMuted`);
            set(memberMuteRef, newMutedState);
        };

        window.sendVoiceRoomMessage = () => {
            const input = document.getElementById('voiceRoomMessageInput');
            const text = input.value.trim();
            if (!text || !currentVoiceRoomId) return;
            
            const message = {
                type: 'text',
                text: text,
                senderId: currentUser.uid,
                senderName: currentUserData.displayName,
                timestamp: serverTimestamp()
            };
            
            push(ref(db, `voice_rooms/${currentVoiceRoomId}/chat`), message);
            input.value = '';
        };

        window.handleVoiceRoomEnter = (event) => {
            if (event.key === 'Enter') {
                sendVoiceRoomMessage();
            }
        };

        window.openGiftModalForVoiceRoomUser = (targetUserId, roomId) => {
            const targetUserData = allUsersData[targetUserId];
            if (!targetUserData) return showNotification('Cannot find this user.', 'error');
            
            giftTarget = { type: 'voice_room', id: roomId, authorId: targetUserId };
            UIElements.giftRecipient.textContent = targetUserData.displayName;
            UIElements.giftModal.classList.add('show');
        };

        // --- NOTIFICATION ---
        let notificationTimeout;
        const showNotification = (message, type = 'info') => {
            const area = document.getElementById('notification-area'); const notification = document.createElement('div');
            notification.className = `notification ${type}`; notification.textContent = message;
            if(area.firstChild) area.removeChild(area.firstChild); area.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove(), { once: true }); }, 5000);
        };
    </script>
    
    <!-- Social Bar Ad Script -->
    <script type='text/javascript' src='//pl27003114.profitableratecpm.com/11/c2/2d/11c22db8fc88d978b6a6ab37033cf5b2.js'></script>
</body>
</html>